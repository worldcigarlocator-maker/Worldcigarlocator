<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Business Dashboard ‚Äì World Cigar Locator</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 2rem; color: #333; }
    nav { text-align: center; margin-bottom: 2rem; }
    nav a { color: #b8860b; text-decoration: none; margin: 0 1rem; font-weight: bold; }
    nav a:hover { text-decoration: underline; }

    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap: 1rem; margin-bottom: 2rem; }
    .kpi-card { background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:1rem; text-align:center; }
    .kpi-card h2 { color:#b8860b; margin:0; font-size:1.6rem; }
    .kpi-card p { margin:0.3rem 0 0; font-size:0.9rem; color:#666; }

    .mini-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem; }
    .mini-card { background:#fff; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding:1rem; }
    .mini-card h3 { margin:0 0 0.3rem; color:#333; }
    .mini-card p { margin:0.2rem 0; font-size:0.9rem; color:#555; }
    .actions { margin-top:0.8rem; display:flex; gap:0.5rem; }
    .actions button { flex:1; border:none; border-radius:6px; padding:0.4rem; font-weight:bold; cursor:pointer; color:#fff; }
    .approve{background:#28a745;} .flag{background:#ff8c00;} .delete{background:#dc3545;}
    .restore{background:#007bff;}
    .actions button:hover{opacity:0.9;}

    .toast{position:fixed;bottom:1rem;right:1rem;background:#333;color:#fff;padding:0.8rem 1.2rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);opacity:0.95;}
  </style>
</head>
<body>
  <nav>
    <a href="backoffice-test15g.html">üè† Home</a>
    <a href="#">‚úÖ Approved</a>
    <a href="#">‚è≥ Pending</a>
    <a href="#">üö© Flagged</a>
    <a href="backoffice-business-test18.html"><strong>üíº Business</strong></a>
    <a href="backoffice-trash.html">üóëÔ∏è Trash</a>
  </nav>

  <h1 style="text-align:center;color:#b8860b;">Business Dashboard</h1>
  <div class="kpi-grid" id="kpiGrid"></div>
  <div class="mini-grid" id="topStoresGrid"></div>

  <div id="toast"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(
      "https://gbxxoeplkzbhsvagnfsr.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4"
    );

    async function loadData() {
      const { data, error } = await supabase.from("stores").select("*").eq("deleted", false);
      if (error) return console.error(error);
      const total = data.length;
      const approved = data.filter(s=>s.approved).length;
      const flagged = data.filter(s=>s.flagged).length;
      const avg = (data.reduce((a,s)=>a+(s.rating||0),0)/total).toFixed(1);
      document.getElementById("kpiGrid").innerHTML = `
        <div class="kpi-card"><h2>${total}</h2><p>Total</p></div>
        <div class="kpi-card"><h2>${approved}</h2><p>Approved</p></div>
        <div class="kpi-card"><h2>${flagged}</h2><p>Flagged</p></div>
        <div class="kpi-card"><h2>${avg}</h2><p>Average Rating</p></div>
      `;

      const grid=document.getElementById("topStoresGrid");
      grid.innerHTML="";
      data.sort((a,b)=>(b.rating||0)-(a.rating||0)).slice(0,10).forEach(store=>{
        const card=document.createElement("div");
        card.className="mini-card";
        card.innerHTML=`
          <h3>${store.name}</h3>
          <p>${store.city}, ${store.country}</p>
          <p>‚≠ê ${store.rating||0}</p>
          <div class="actions">
            <button class="approve">Approve</button>
            <button class="flag">Flag</button>
            <button class="delete">Delete</button>
          </div>`;
        card.querySelector(".approve").onclick=()=>updateStore(store.id,{approved:true,status:"approved"});
        card.querySelector(".flag").onclick=()=>updateStore(store.id,{flagged:true});
        card.querySelector(".delete").onclick=()=>softDelete(store.id);
        grid.appendChild(card);
      });
    }

    async function updateStore(id,update){
      const {error}=await supabase.from("stores").update(update).eq("id",id);
      if(error)console.error(error);
      showToast("Updated!"); loadData();
    }
    async function softDelete(id){
      if(!confirm("Move to Trash?"))return;
      const {error}=await supabase.from("stores").update({deleted:true,deleted_at:new Date().toISOString()}).eq("id",id);
      if(error)console.error(error);
      showToast("Moved to Trash!"); loadData();
    }

    function showToast(msg){
      const t=document.createElement("div");
      t.className="toast"; t.textContent=msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(),2500);
    }

    loadData();
  </script>
</body>
</html>
