<!-- backoffice-home-clean-final.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backoffice — Home (Clean Final)</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
  <style>
    :root {
      --primary: #2f78c4;
      --primary-dark: #2466a8;
      --success: #1d8348;
      --danger: #c0392b;
      --bg: #f5f6f8;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 1.5rem;
    }
    nav {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    nav a {
      text-decoration: none;
      border: 1px solid var(--primary);
      border-radius: 6px;
      padding: 0.4rem 0.7rem;
      font-weight: bold;
      color: var(--primary);
      background: white;
    }
    nav a:hover { background: var(--primary); color: white; }

    h1 {
      text-align: center;
      margin: 1rem 0 2rem;
      color: var(--primary-dark);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .card h3 { margin: 0 0 .5rem; color: var(--primary-dark); }
    .card p { margin: 0.2rem 0; color: var(--muted); font-size: 0.9rem; }

    .actions {
      margin-top: .8rem;
      display: flex;
      gap: .3rem;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 0.4rem 0.6rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.8rem;
      transition: background 0.2s;
    }
    .approve { background: var(--success); color: #fff; }
    .flag { background: #f1c40f; color: #000; }
    .delete { background: var(--danger); color: #fff; }
    .restore { background: var(--primary-dark); color: #fff; }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--border);
      padding: .6rem 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 9999;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <nav>
    <a href="backoffice-home-clean-final.html">Home</a>
    <a href="backoffice-business.html">Business</a>
    <a href="backoffice-addstore.html">Add Store</a>
  </nav>

  <h1>Backoffice Home</h1>

  <div id="storeGrid" class="grid"></div>

  <div id="toast" class="toast" style="display:none;"></div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://gbxxoeplkzbhsvagnfsr.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4"
    );

    const storeGrid = document.getElementById("storeGrid");
    const toast = document.getElementById("toast");

    // 🧠 Load all stores
    async function loadStores() {
      const { data, error } = await supabase.from("stores").select("*").order("created_at", { ascending: false });
      if (error) {
        console.error("❌ Load error:", error);
        showToast("Failed to load stores", "error");
        return;
      }

      storeGrid.innerHTML = data.map(store => `
        <div class="card">
          <h3>${store.name || "Unnamed"}</h3>
          <p>${store.city || ""}, ${store.country || ""}</p>
          <p>Status: <strong>${store.status}</strong></p>
          <p>Type: ${store.type || "–"}</p>
          <div class="actions">
            <button class="approve" onclick="updateStatus('${store.id}', ${!store.approved})">
              ${store.approved ? "Unapprove" : "Approve"}
            </button>
            <button class="flag" onclick="toggleFlag('${store.id}', ${store.flagged})">
              ${store.flagged ? "Unflag" : "Flag"}
            </button>
            <button class="delete" onclick="softDelete('${store.id}')">Delete</button>
          </div>
        </div>
      `).join("");
    }

    window.updateStatus = async function(id, approved) {
      try {
        console.log("🔹 updateStatus triggered:", id, approved);

        // 1️⃣ Fetch store info
        const { data: store, error: fetchError } = await supabase
          .from("stores")
          .select("country, continent")
          .eq("id", id)
          .single();
        if (fetchError) throw fetchError;

        // 2️⃣ Update approval
        const { error: updateError } = await supabase
          .from("stores")
          .update({
            approved,
            status: approved ? "approved" : "pending",
            approved_at: approved ? new Date().toISOString() : null
          })
          .eq("id", id);
        if (updateError) throw updateError;

        // 3️⃣ Update region counters
        const delta = approved ? 1 : -1;
        await supabase.rpc("increment_store_count", {
          target_table: "countries",
          target_key: "name",
          target_value: store.country,
          delta
        });
        await supabase.rpc("increment_store_count", {
          target_table: "continents",
          target_key: "name",
          target_value: store.continent,
          delta
        });

        showToast(approved ? `✅ Approved ${store.country}` : `⏳ Unapproved ${store.country}`, "success");
        loadStores();
      } catch (err) {
        console.error("❌ updateStatus error:", err);
        showToast(`Failed: ${err.message}`, "error");
      }
    }

    window.toggleFlag = async function(id, flagged) {
      try {
        const { error } = await supabase.from("stores").update({ flagged: !flagged }).eq("id", id);
        if (error) throw error;
        showToast(flagged ? "🚫 Unflagged" : "🚩 Flagged", "success");
        loadStores();
      } catch (err) {
        console.error("❌ toggleFlag:", err);
        showToast("Failed to toggle flag", "error");
      }
    }

    window.softDelete = async function(id) {
      try {
        const deletedUntil = new Date(Date.now() + 48*60*60*1000).toISOString();
        const { error } = await supabase.from("stores").update({ status: "deleted", deleted_until: deletedUntil }).eq("id", id);
        if (error) throw error;
        showToast("🗑️ Moved to Trash (48h)", "success");
        loadStores();
      } catch (err) {
        console.error("❌ softDelete:", err);
        showToast("Failed to delete", "error");
      }
    }

    function showToast(message, type="info") {
      toast.textContent = message;
      toast.style.display = "block";
      toast.style.borderColor = type === "error" ? "var(--danger)" : "var(--success)";
      setTimeout(() => toast.style.display = "none", 2500);
    }

    loadStores();
  </script>
</body>
</html>
