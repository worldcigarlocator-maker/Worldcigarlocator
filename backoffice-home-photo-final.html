<!-- ✅ Backoffice Home — Photo FINAL (GH compatible) | 2025-10-15 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Backoffice — Home (Photo Final)</title>
  <!-- Global Supabase v2 (no module) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --primary:#2f78c4; --primary-dark:#2466a8;
      --success:#1d8348; --warning:#b36e00; --danger:#c0392b;
      --bg:#f5f6f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:2rem;color:var(--text);}
    h1{text-align:center;margin-bottom:1.5rem;color:var(--primary-dark);}
    .top-bar{display:flex;justify-content:center;flex-wrap:wrap;gap:.5rem;margin-bottom:1.2rem}
    .top-bar button{background:var(--primary);color:#fff;border:none;padding:.6rem 1rem;border-radius:8px;cursor:pointer;font-weight:bold;font-size:.9rem}
    .top-bar button.secondary{background:#fff;color:var(--primary);border:2px solid var(--primary)}
    .top-bar button:hover{background:var(--primary-dark);color:#fff}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.2rem}
    .card{background:var(--card);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);overflow:hidden;display:flex;flex-direction:column}
    .card img{width:100%;height:180px;object-fit:cover}
    .card-content{padding:1rem;flex:1}
    .badges{display:flex;gap:.4rem;flex-wrap:wrap;margin-bottom:.4rem}
    .badge{display:inline-block;padding:.25rem .7rem;border-radius:12px;font-size:.8rem;font-weight:bold;color:#fff}
    .store{background:#007bff}.lounge{background:#28a745}.other{background:#ff8c00}.flagged{background:#dc3545!important}
    .rating{color:#b8860b;margin-top:.3rem}
    .status{font-size:.85rem;color:var(--muted);margin-top:.3rem}
    .date{font-size:.75rem;color:#999;margin-top:.3rem}
    .access-line{color:var(--primary-dark);font-size:.85rem;margin:.2rem 0}
    .btn-row{display:flex;gap:.5rem;padding:0 1rem 1rem}
    .btn-row button{flex:1;padding:.55rem;border:none;border-radius:8px;cursor:pointer;font-weight:bold}
    .approve{background:var(--success);color:#fff}
    .flag{background:#ff8c00;color:#fff}
    .soft-delete{background:var(--danger);color:#fff}
    .approve:hover{background:#166f3e}.flag:hover{background:#d97706}.soft-delete:hover{background:#a83228}
    #toast-container{position:fixed;bottom:1rem;right:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:9999}
    .toast{background:#333;color:#fff;padding:.8rem 1.2rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2);opacity:.97}
    .toast.success{background:#28a745}.toast.error{background:#dc3545}.toast.info{background:#2f78c4}
    #metaRow{text-align:center;color:var(--muted);margin-bottom:1rem}

    /* Modal (Add Store) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9998}
    .modal{background:#fff;width:min(920px,92vw);max-height:92vh;overflow:auto;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:1rem 1.2rem}
    .modal h2{margin:.2rem 0 1rem;color:#333}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
    .form-grid label{font-weight:bold;font-size:.9rem}
    .form-grid input[type="text"], .form-grid input[type="tel"], .form-grid input[type="url"]{
      width:100%;padding:.55rem;border:1px solid #ccc;border-radius:6px;font-size:.95rem;
    }
    .type-row{display:flex;gap:.5rem;flex-wrap:wrap}
    .chip{border:1px solid var(--border);padding:.35rem .7rem;border-radius:16px;cursor:pointer;user-select:none}
    .chip.active{background:#eef6ff;border-color:#bcd7ff;color:#145b99}
    .access-box{display:none;background:#f8fafc;border:1px dashed #cfe1ff;padding:.6rem .7rem;border-radius:8px}
    .stars{display:flex;gap:.35rem;font-size:1.6rem;cursor:pointer;color:#ccc}
    .stars .sel{color:#b8860b}
    .preview{margin-top:.6rem;text-align:center}
    .preview img{max-width:100%;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.18)}
    .modal-actions{display:flex;gap:.6rem;margin-top:1rem;justify-content:flex-end}
    .btn{padding:.7rem 1rem;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.secondary{background:#e5e7eb;color:#111}
    .btn.danger{background:var(--danger);color:#fff}
  </style>
</head>
<body>
  <h1>Backoffice Home</h1>

  <div class="top-bar">
    <button class="secondary" onclick="route('home')">Home</button>
    <button onclick="route('approved')">Approved</button>
    <button onclick="route('pending')">Pending</button>
    <button onclick="route('flagged')">Flagged</button>
    <button onclick="route('trash')">Trash</button>
    <button onclick="window.location.href='backoffice-business-final.html'">Business</button>
    <button onclick="openAddModal()">Add Store</button>
  </div>

  <div id="metaRow"></div>
  <div id="storeGrid" class="grid"></div>
  <div id="toast-container"></div>

  <!-- Add Store Modal -->
  <div id="addModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <h2>Add Store / Lounge / Other</h2>
      <div class="form-grid">
        <div style="grid-column:1/-1">
          <label>Search (Google)</label>
          <input id="gAddress" type="text" placeholder="Start typing a place…" />
        </div>

        <div>
          <label>Store Name</label>
          <input id="name" type="text" />
        </div>
        <div>
          <label>Phone</label>
          <input id="phone" type="tel" />
        </div>

        <div style="grid-column:1/-1">
          <label>Address</label>
          <input id="addr" type="text" />
        </div>

        <div>
          <label>City</label>
          <input id="city" type="text" />
        </div>
        <div>
          <label>Country</label>
          <input id="country" type="text" />
        </div>

        <div style="grid-column:1/-1">
          <label>Website</label>
          <input id="website" type="url" placeholder="https://…" />
        </div>

        <div style="grid-column:1/-1">
          <label>Categories (multi-select)</label>
          <div class="type-row" id="typeRow">
            <span class="chip" data-type="store">Store</span>
            <span class="chip" data-type="lounge">Lounge</span>
            <span class="chip" data-type="other">Other</span>
          </div>
        </div>

        <div id="accessBox" class="access-box" style="grid-column:1/-1">
          <label style="display:block;margin-bottom:.35rem;">Lounge access</label>
          <label><input type="radio" name="access" value="public"> Open to Public</label>&nbsp;&nbsp;
          <label><input type="radio" name="access" value="temporary"> Temporary Members</label>&nbsp;&nbsp;
          <label><input type="radio" name="access" value="members"> Members Only</label>
        </div>

        <div style="grid-column:1/-1">
          <label>Rating</label>
          <div id="stars" class="stars" aria-label="Rating">
            <span data-v="1">★</span><span data-v="2">★</span><span data-v="3">★</span><span data-v="4">★</span><span data-v="5">★</span>
          </div>
        </div>

        <div class="preview" id="preview" style="grid-column:1/-1"></div>
      </div>

      <div class="modal-actions">
        <button class="btn secondary" onclick="closeAddModal()">Cancel</button>
        <button class="btn primary" onclick="saveStore()">Save Store</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- Supabase ---------- */
    const supabase = window.supabase.createClient(
      "https://gbxxoeplkzbhsvagnfsr.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4"
    );

    const grid = document.getElementById("storeGrid");
    const metaRow = document.getElementById("metaRow");
    let currentView = "home";

    /* ---------- Router ---------- */
    async function route(view){
      currentView = view;
      metaRow.textContent = "";
      grid.innerHTML = "";

      if (view === "home")     await loadStores({ excludeDeleted:true, title:"All active locations" });
      if (view === "approved") await loadStores({ approved:true,  title:"Approved" });
      if (view === "pending")  await loadStores({ approved:false, title:"Pending" });
      if (view === "flagged")  await loadStores({ flagged:true,   title:"Flagged" });
      if (view === "trash")    await loadTrash();
    }

    /* ---------- Data loaders ---------- */
    async function loadStores(opts = {}){
      let q = supabase.from("stores").select("*").order("created_at",{ascending:false});

      if (opts.excludeDeleted) q = q.eq("deleted", false);
      if (opts.approved === true)  q = q.eq("approved", true).eq("deleted", false);
      if (opts.approved === false) q = q.eq("approved", false).eq("deleted", false);
      if (opts.flagged)            q = q.eq("flagged", true).eq("deleted", false);

      const { data, error } = await q;
      if (error){ grid.innerHTML = `<p style="color:red;">${error.message}</p>`; return; }
      if (!data?.length){ grid.innerHTML = `<p>No stores found.</p>`; return; }

      metaRow.textContent = opts.title || "";
      data.forEach(renderCard);
    }

    async function loadTrash(){
      const { data, error } = await supabase
        .from("stores")
        .select("*")
        .eq("deleted", true)
        .order("deleted_until",{ascending:true});
      if (error){ grid.innerHTML = `<p style="color:red;">${error.message}</p>`; return; }
      if (!data?.length){ grid.innerHTML = `<p>Trash is empty.</p>`; return; }
      metaRow.textContent = "Trash (48h auto-delete)";
      data.forEach(renderCardTrash);
    }

    /* ---------- Photo helper ---------- */
    function photoUrlFromRef(photoRef){
      if (!photoRef) return null;
      const key = "AIzaSyDdn7E6_dfwUjGQ1IUdJ2rQXUeEYIIzVtQ"; // 🔁 REPLACE with your Maps/Places API key (HTTP referrer allowed for GitHub Pages)
      return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photo_reference=${encodeURIComponent(photoRef)}&key=${key}`;
    }

    /* ---------- Render helpers ---------- */
    function decorate(store){
      const types = Array.isArray(store.types) ? store.types.map(t=>String(t).toLowerCase()) : [ (store.type||"other").toLowerCase() ];
      const badges = types.map(t=>`<span class="badge ${t}">${t}</span>`).join(" ");

      let img = "images/other.jpg";
      const photoByRef = store.photo_reference ? photoUrlFromRef(store.photo_reference) : null;
      if (photoByRef) img = photoByRef;
      else if (types.includes("lounge")) img = "images/lounge.jpg";
      else if (types.includes("store"))  img = "images/store.jpg";

      const stars = store.rating ? "★".repeat(store.rating) + "☆".repeat(5-store.rating) : "☆☆☆☆☆";

      let access = "";
      if (types.includes("lounge") && store.access){
        const text = store.access === "members"   ? "🔒 Members only"
                  : store.access === "temporary" ? "⏳ Temporary members"
                  : "🌐 Public access";
        access = `<div class="access-line">${text}</div>`;
      }
      return { badges, img, stars, access };
    }

    function renderCard(store){
      const { badges, img, stars, access } = decorate(store);
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img src="${img}" alt="${store.name||""}"
             onerror="this.onerror=null; this.src='images/store.jpg';">
        <div class="card-content">
          <div class="badges">${store.flagged?'<span class="badge flagged">Flagged</span>':''}${badges}</div>
          <h3>${store.name || "Unnamed"}</h3>
          <p>${store.address || ""}</p>
          <p>${store.city || ""}, ${store.country || ""}</p>
          ${access}
          <div class="rating">${stars}</div>
          <div class="status">${store.approved ? "✅ Approved" : "⏳ Pending"}</div>
          <div class="date">${store.created_at ? new Date(store.created_at).toLocaleDateString() : ""}</div>
        </div>
        <div class="btn-row">
          <button class="approve" onclick="updateStatus('${store.id}', ${!store.approved})">${store.approved ? "Unapprove" : "Approve"}</button>
          <button class="flag" onclick="toggleFlag('${store.id}', ${!!store.flagged})">${store.flagged ? "Unflag" : "Flag"}</button>
          <button class="soft-delete" onclick="softDelete('${store.id}')">Delete</button>
        </div>`;
      grid.appendChild(card);
    }

    function renderCardTrash(store){
      const { badges, img } = decorate(store);
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img src="${img}" alt="${store.name||""}"
             onerror="this.onerror=null; this.src='images/store.jpg';">
        <div class="card-content">
          <div class="badges">${badges}</div>
          <h3>${store.name || "Unnamed"}</h3>
          <p>${store.city || ""}, ${store.country || ""}</p>
          <div class="status">Deleted until: ${store.deleted_until ? new Date(store.deleted_until).toLocaleString() : "-"}</div>
        </div>
        <div class="btn-row">
          <button class="approve" onclick="restoreStore('${store.id}')">Restore</button>
          <button class="soft-delete" onclick="permanentDelete('${store.id}')">Delete permanently</button>
        </div>`;
      grid.appendChild(card);
    }

    /* ---------- Actions ---------- */
    async function updateStatus(id, approved){
      try{
        const { error } = await supabase
          .from("stores")
          .update({
            approved,
            status: approved ? "approved" : "pending",
            approved_at: approved ? new Date().toISOString() : null
          })
          .eq("id", id);
        if (error) throw error;
        showToast(approved ? "✅ Store approved" : "⏳ Approval removed","success");
        reloadCurrent();
      }catch(err){
        console.error("❌ updateStatus error:", err);
        showToast(`Error: ${err.message}`,"error");
      }
    }

    async function toggleFlag(id, flagged){
      try{
        const { error } = await supabase.from("stores").update({ flagged: !flagged }).eq("id", id);
        if (error) throw error;
        showToast(flagged ? "🚫 Unflagged" : "🚩 Flagged","success");
        reloadCurrent();
      }catch(err){
        console.error("❌ toggleFlag error:", err);
        showToast("Failed to toggle flag","error");
      }
    }

    // Soft delete → only uses deleted + deleted_until (inte status → undviker CHECK-constraint)
    async function softDelete(id){
      try{
        const deletedUntil = new Date(Date.now() + 48*60*60*1000).toISOString();
        const { error } = await supabase
          .from("stores")
          .update({ deleted:true, deleted_until:deletedUntil })
          .eq("id", id);
        if (error) throw error;
        showToast("🗑️ Moved to Trash (48h)","success");
        reloadCurrent();
      }catch(err){
        console.error("❌ softDelete error:", err);
        showToast(`Failed to delete: ${err.message}`,"error");
      }
    }

    async function restoreStore(id){
      try{
        const { error } = await supabase
          .from("stores")
          .update({ deleted:false, deleted_until:null })
          .eq("id", id);
        if (error) throw error;
        showToast("♻️ Restored","success");
        route("home");
      }catch(err){
        console.error("❌ restoreStore error:", err);
        showToast(`Failed to restore: ${err.message}`,"error");
      }
    }

    async function permanentDelete(id){
      try{
        const { error } = await supabase.from("stores").delete().eq("id", id);
        if (error) throw error;
        showToast("💀 Permanently deleted","success");
        reloadCurrent();
      }catch(err){
        console.error("❌ permanentDelete error:", err);
        showToast("Failed to delete permanently","error");
      }
    }

    function reloadCurrent(){ route(currentView); }
    function showToast(msg,type="info"){
      const c=document.getElementById("toast-container");
      const t=document.createElement("div");
      t.className=`toast ${type}`;
      t.textContent=msg;
      c.appendChild(t);
      setTimeout(()=>t.remove(),3000);
    }

    /* ---------- Add Store Modal & Google Places ---------- */
    let selected = {
      types: new Set(), rating: 0, lat: null, lng: null, photoRef: null, place_id: null
    };

    function openAddModal(){ document.getElementById("addModal").style.display="flex"; }
    function closeAddModal(){ document.getElementById("addModal").style.display="none"; }

    // Toggle chips
    (function initChips(){
      const row = document.getElementById("typeRow");
      row.addEventListener("click",(e)=>{
        const chip = e.target.closest(".chip");
        if (!chip) return;
        const t = chip.dataset.type;
        if (chip.classList.contains("active")){
          chip.classList.remove("active");
          selected.types.delete(t);
        } else {
          chip.classList.add("active");
          selected.types.add(t);
        }
        // Show access if Lounge selected
        document.getElementById("accessBox").style.display = selected.types.has("lounge") ? "block" : "none";
        updatePreview();
      });
    })();

    // Stars
    (function initStars(){
      const stars = document.getElementById("stars");
      stars.addEventListener("click",(e)=>{
        const v = +e.target.dataset.v;
        if (!v) return;
        selected.rating = v;
        [...stars.children].forEach((el,i)=> el.classList.toggle("sel", i < v));
      });
    })();

    // Build preview image
    function updatePreview(){
      const pv = document.getElementById("preview");
      let img = "images/other.jpg";
      if (selected.photoRef){
        const u = photoUrlFromRef(selected.photoRef);
        if (u) img = u;
      } else if (selected.types.has("lounge")) img = "images/lounge.jpg";
      else if (selected.types.has("store")) img = "images/store.jpg";
      pv.innerHTML = `<img src="${img}" alt="Preview" onerror="this.onerror=null; this.src='images/store.jpg';">`;
    }

    // Google Places Autocomplete + Details to extract photo_reference
    let placesService = null;
    function initPlaces(){
      const input = document.getElementById("gAddress");
      const ac = new google.maps.places.Autocomplete(input, {
        fields:["place_id","address_components","geometry","name","formatted_address","international_phone_number","website","photos"]
      });

      // PlacesService (no map needed)
      placesService = new google.maps.places.PlacesService(document.createElement('div'));

      ac.addListener("place_changed", ()=>{
        const place = ac.getPlace();
        if (!place) return;

        // Fill basics from Autocomplete result
        document.getElementById("name").value = place.name || "";
        document.getElementById("addr").value = place.formatted_address || "";

        // City/country best effort
        let city = place.address_components?.find(c=>c.types.includes("locality"))
               || place.address_components?.find(c=>c.types.includes("postal_town"))
               || place.address_components?.find(c=>c.types.includes("administrative_area_level_2"));
        let country = place.address_components?.find(c=>c.types.includes("country"));

        document.getElementById("city").value = city?.long_name || "";
        document.getElementById("country").value = country?.long_name || "";
        document.getElementById("phone").value = place.international_phone_number || "";
        document.getElementById("website").value = place.website || "";

        selected.lat = place.geometry?.location?.lat() || null;
        selected.lng = place.geometry?.location?.lng() || null;
        selected.place_id = place.place_id || null;
        selected.photoRef = null; // will attempt via details below

        // Try to get a stable photo_reference via Places Details
        if (selected.place_id){
          placesService.getDetails({
            placeId: selected.place_id,
            fields: ["photos"]
          }, (res, status)=>{
            if (status === google.maps.places.PlacesServiceStatus.OK && res?.photos?.length){
              // In Details response, photo objects expose photo_reference
              // @ts-ignore (the field is available even if not typed)
              selected.photoRef = res.photos[0].photo_reference || null;
            } else if (place.photos?.length){
              // Fallback: sometimes Autocomplete photos also include photo_reference
              // @ts-ignore
              selected.photoRef = place.photos[0].photo_reference || null;
            }
            updatePreview();
          });
        } else {
          // As last resort try from Autocomplete object (may not have reference)
          if (place.photos?.length){
            // @ts-ignore
            selected.photoRef = place.photos[0].photo_reference || null;
          }
          updatePreview();
        }
      });
    }
    window.initPlaces = initPlaces; // callback for Google script

    async function saveStore(){
      try{
        const name = document.getElementById("name").value.trim();
        const address = document.getElementById("addr").value.trim();
        const city = document.getElementById("city").value.trim();
        const country = document.getElementById("country").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const website = document.getElementById("website").value.trim();
        const access = document.querySelector("input[name='access']:checked")?.value || null;

        if (!name || !address || !city || !country){
          showToast("Please fill all required fields (name, address, city, country)","error");
          return;
        }
        if (selected.types.size === 0){
          showToast("Pick at least one category (Store/Lounge/Other)","error");
          return;
        }

        const typesArr = Array.from(selected.types);
        // primary type for compatibility
        const primaryType = typesArr[0] || null;

        const payload = {
          name, address, city, country, phone, website,
          type: primaryType,
          types: typesArr,
          access,
          rating: selected.rating || 0,
          approved: false,
          lat: selected.lat, lng: selected.lng,
          photo_reference: selected.photoRef,
          place_id: selected.place_id || null,
          deleted: false,
          status: "pending"
        };

        const { error } = await supabase.from("stores").insert([payload]);
        if (error) throw error;

        showToast("✅ Store added (pending)","success");
        closeAddModal();
        // Clear simple fields
        ["gAddress","name","addr","city","country","phone","website"].forEach(id=>document.getElementById(id).value="");
        document.querySelectorAll("input[name='access']").forEach(r=>r.checked=false);
        document.getElementById("accessBox").style.display="none";
        selected = { types:new Set(), rating:0, lat:null, lng:null, photoRef:null, place_id:null };
        updatePreview();
        // Reload list
        route("pending");
      }catch(err){
        console.error("❌ saveStore error:", err);
        showToast(`Failed to add store: ${err.message}`,"error");
      }
    }

    /* ---------- Init ---------- */
    route("home");
  </script>

  <!-- ✅ Load Google Maps Places (World Cigar Locator key) -->
  <!-- Enabled for Places API + Maps JavaScript API -->
  <!-- Allowed referrers:
       https://worldcigarlocator-maker.github.io/*
       https://*.github.io/* -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyDCr9J_7sC0x5vP3Q7lQAI5hSw7Fy7Jk&libraries=places&callback=initPlaces"></script>
</body>
</html>

