<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Butik</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #fdfdfc;
    }

    h1#storeName {
      color: #b8860b; /* guld */
      margin-top: 0;
      font-size: 2rem;
    }

    h1#storeName a {
      color: #b8860b;
      text-decoration: none;
      transition: color 0.2s ease;
    }

    h1#storeName a:hover {
      color: #daa520; /* ljusare guld */
      text-decoration: underline;
    }

    #storeAddress {
      margin: 0.3rem 0 1rem 0;
      color: #444;
    }

    #storeLink {
      color: #0077cc;
      text-decoration: none;
    }
    #storeLink:hover {
      text-decoration: underline;
    }

    #ratingSummary {
      margin-top: 1rem;
      font-size: 1rem;
      color: #b8860b; /* guld √§ven f√∂r snittbetyg */
      font-weight: bold;
    }

    .stars span {
      font-size: 2rem;
      cursor: pointer;
      color: #ccc;
      transition: color 0.2s ease;
    }
    .stars span.active {
      color: gold;
    }

    textarea {
      width: 100%;
      height: 80px;
      margin-top: 0.5rem;
    }

    button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      border: none;
      background: #b8860b;
      color: white;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #daa520;
    }

    .review {
      margin: 1rem 0;
      padding: 0.5rem;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <h1 id="storeName">Butiksnamn</h1>
  <p id="storeAddress"></p>
  <p><a id="storeLink" target="_blank"></a></p>

  <h2>Betyg</h2>
  <div id="ratingSummary">Laddar betyg...</div>
  <div class="stars" id="stars"></div>

  <h2>L√§mna recension</h2>
  <textarea id="reviewText" placeholder="Skriv en recension..."></textarea><br>
  <button id="submitReview">Skicka</button>

  <h2>Recensioner</h2>
  <div id="reviews">Laddar recensioner...</div>

<script>
  // üîë Din Supabase-info
  const supabaseUrl = "DIN_SUPABASE_URL";
  const supabaseKey = "DIN_SUPABASE_ANON_KEY";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // H√§mta store_id fr√•n URL
  const urlParams = new URLSearchParams(window.location.search);
  const storeId = urlParams.get("store");

  const starsContainer = document.getElementById("stars");
  let selectedRating = 0;

  // Skapa 5 stj√§rnor
  for (let i = 1; i <= 5; i++) {
    const star = document.createElement("span");
    star.textContent = "‚òÖ";
    star.addEventListener("click", () => {
      selectedRating = i;
      highlightStars(i);
    });
    starsContainer.appendChild(star);
  }

  function highlightStars(count) {
    [...starsContainer.children].forEach((s, i) => {
      s.classList.toggle("active", i < count);
    });
  }

  // üöÄ H√§mta store-info
  async function loadStore() {
    const { data, error } = await supabaseClient
      .from("stores")
      .select("*")
      .eq("id", storeId)
      .single();

    if (data) {
      const nameElem = document.getElementById("storeName");
      nameElem.innerHTML = `<a href="${data.link}" target="_blank">${data.name}</a>`;

      document.getElementById("storeAddress").textContent = data.address || "";
      const link = document.getElementById("storeLink");
      link.textContent = data.link || "";
      link.href = data.link || "#";
    }
  }

  // üöÄ H√§mta rating-sammanfattning fr√•n vyn
  async function loadRatingSummary() {
    const { data, error } = await supabaseClient
      .from("store_ratings_summary")
      .select("*")
      .eq("store_id", storeId)
      .single();

    if (data) {
      document.getElementById("ratingSummary").textContent =
        `‚≠ê ${data.average_rating || 0} (${data.total_ratings} r√∂ster, ${data.total_reviews} recensioner)`;
    } else {
      document.getElementById("ratingSummary").textContent =
        "‚≠ê Inga betyg √§n.";
    }
  }

  // üöÄ H√§mta recensioner
  async function loadReviews() {
    const { data, error } = await supabaseClient
      .from("ratings")
      .select("rating, review, created_at")
      .eq("store_id", storeId)
      .order("created_at", { ascending: false });

    const reviewsDiv = document.getElementById("reviews");
    reviewsDiv.innerHTML = "";
    if (data && data.length > 0) {
      data.forEach(r => {
        const div = document.createElement("div");
        div.className = "review";
        div.textContent = `‚≠ê ${r.rating} ‚Äì ${r.review || ""}`;
        reviewsDiv.appendChild(div);
      });
    } else {
      reviewsDiv.textContent = "Inga recensioner √§n.";
    }
  }

  // üöÄ Spara ny recension
  document.getElementById("submitReview").addEventListener("click", async () => {
    const text = document.getElementById("reviewText").value;
    if (!selectedRating) {
      alert("V√§lj antal stj√§rnor f√∂rst!");
      return;
    }

    const { error } = await supabaseClient
      .from("ratings")
      .insert([{ store_id: storeId, rating: selectedRating, review: text }]);

    if (error) {
      alert("Kunde inte spara recensionen: " + error.message);
    } else {
      document.getElementById("reviewText").value = "";
      selectedRating = 0;
      highlightStars(0);
      await loadRatingSummary();
      await loadReviews();
    }
  });

  // Ladda allt
  loadStore();
  loadRatingSummary();
  loadReviews();
</script>
</body>
</html>
