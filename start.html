<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Min v√§rldskarta</title>
  <style>
    body {
      margin: 0;
      display: flex;
      font-family: sans-serif;
    }

    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #333;
      color: #fff;
      padding: 1rem;
      text-align: center;
      z-index: 1000;
    }

    #sidebar {
      width: 260px;
      background: #f8f9fa;
      border-right: 1px solid #ddd;
      padding: 1rem;
      height: 100vh;
      overflow-y: auto;
      margin-top: 60px; /* under headern */
    }

    #main {
      flex: 1;
      padding: 2rem;
      margin-top: 60px; /* under headern */
    }

    #sidebar ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    #sidebar li {
      margin: 0.3rem 0;
      cursor: pointer;
      user-select: none;
    }

    .nested {
      display: none;
      margin-left: 1.2rem;
    }
    .nested.active {
      display: block;
    }

    .arrow {
      font-size: 0.8rem;
      margin-right: 0.3rem;
    }

    button.toggle {
      background: none;
      border: 0;
      padding: 4px 2px;
      text-align: left;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Banner -->
  <header>
    <h1>üåç Min v√§rldskarta</h1>
  </header>

  <!-- Sidomeny -->
  <div id="sidebar">
    <ul id="sidebarMenu"></ul>
  </div>

  <!-- Huvudinneh√•ll -->
  <div id="main">
    <h2>V√§lkommen</h2>
    <p>Det h√§r √§r din gamla layout, nu med en dynamisk sidomeny som h√§mtar data fr√•n Supabase.</p>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // üîß Byt till ditt projekt!
    const SUPABASE_URL = "https://gbxxoeplkzbhsvagnfsr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4";
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function buildSidebar() {
      const sidebar = document.getElementById("sidebarMenu");
      if (!sidebar) return;
      sidebar.innerHTML = "<li>Laddar‚Ä¶</li>";

      // H√§mta kontinenter
      const { data: continents, error: e1 } = await db
        .from("continents")
        .select("id, name")
        .order("name");

      // H√§mta l√§nder
      const { data: countries, error: e2 } = await db
        .from("countries")
        .select("id, name, flag, continent_id")
        .order("name");

      if (e1 || e2) {
        sidebar.innerHTML = `<li style="color:red">Fel: ${(e1 || e2).message}</li>`;
        return;
      }

      // Gruppera l√§nder per kontinent
      const grouped = {};
      countries.forEach(c => {
        (grouped[c.continent_id] ||= []).push(c);
      });

      sidebar.innerHTML = "";

      continents.forEach(cont => {
        const li = document.createElement("li");

        // Kontinentknapp
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "toggle";
        btn.innerHTML = `<span class="arrow">‚ñ∫</span> ${cont.name}`;

        const ul = document.createElement("ul");
        ul.className = "nested";

        (grouped[cont.id] || []).forEach(c => {
          const cli = document.createElement("li");
          cli.textContent = `${c.flag || ""} ${c.name}`;
          cli.addEventListener("click", ev => {
            ev.stopPropagation();
            loadCities(c.id, c.name, c.flag);
          });
          ul.appendChild(cli);
        });

        btn.addEventListener("click", () => {
          ul.classList.toggle("active");
          btn.querySelector(".arrow").textContent = ul.classList.contains("active") ? "‚ñº" : "‚ñ∫";
        });

        li.appendChild(btn);
        li.appendChild(ul);
        sidebar.appendChild(li);
      });
    }

    async function loadCities(countryId, countryName, flag) {
      const main = document.getElementById("main");
      if (!main) return;

      main.innerHTML = `<h2>${flag || ""} ${countryName}</h2><p>Laddar st√§der‚Ä¶</p>`;

      const { data: cities, error } = await db
        .from("cities")
        .select("id, name")
        .eq("country_id", countryId)
        .order("name");

      if (error) {
        main.innerHTML = `<h2>${flag || ""} ${countryName}</h2><p style="color:red">${error.message}</p>`;
        return;
      }

      if (!cities || cities.length === 0) {
        main.innerHTML = `<h2>${flag || ""} ${countryName}</h2><p>Inga st√§der hittades.</p>`;
        return;
      }

      const list = document.createElement("ul");
      cities.forEach(city => {
        const li = document.createElement("li");
        li.textContent = city.name;
        list.appendChild(li);
      });

      main.innerHTML = `<h2>${flag || ""} ${countryName}</h2>`;
      main.appendChild(list);
    }

    document.addEventListener("DOMContentLoaded", buildSidebar);
  </script>
</body>
</html>
