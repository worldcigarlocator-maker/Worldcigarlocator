<!-- Analytics V3 (Country & Continent) | 2025-10-22 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Analytics — World Cigar Locator</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

  <style>
    :root{--primary:#2f78c4;--primary-dark:#2466a8;--bg:#f5f6f8;--card:#fff;--text:#1f2937;--border:#e5e7eb;}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:1.2rem;color:var(--text);font-size:10px;}
    h1{text-align:center;margin:0 0 1rem;color:#2b2b2b;font-weight:800;font-size:1.4rem;}
    nav{display:flex;justify-content:center;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}
    nav a{background:#fff;border:1.4px solid var(--primary);color:var(--primary);padding:.35rem .6rem;border-radius:7px;font-weight:800;text-decoration:none;font-size:.9rem}
    nav a:hover{background:var(--primary);color:#fff;}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:9px;box-shadow:0 1px 3px rgba(0,0,0,.05);padding:1rem;margin-bottom:1rem;}
    .row{display:flex;gap:.5rem;flex-wrap:wrap;justify-content:center}
    .btn{background:#fff;border:1.4px solid var(--primary);color:var(--primary);padding:.35rem .6rem;border-radius:7px;font-weight:800;font-size:.9rem;cursor:pointer;}
    .btn:hover{background:var(--primary);color:#fff;}
    .btn.active{background:var(--primary);color:#fff;}
    .chart-title{text-align:center;font-weight:900;font-size:1rem;margin:.4rem 0;}
    table{width:100%;border-collapse:collapse;table-layout:fixed;margin-top:.6rem}
    th,td{padding:.5rem;border-bottom:1px solid #eee;text-align:left;font-size:.9rem;}
    th{background:#f3f4f6;color:#333;}
    td.num{text-align:center;}
  </style>
</head>
<body>
  <h1>World Cigar Locator — Analytics</h1>

  <nav>
    <a href="backoffice.html">Backoffice</a>
    <a href="add-store-backoffice.html">Add Store</a>
  </nav>

  <div class="panel">
    <div class="row">
      <button class="btn active" id="btnCountry">By Country</button>
      <button class="btn" id="btnContinent">By Continent</button>
      <button class="btn" id="btnType">By Type</button>
    </div>
    <div class="chart-title" id="chartTitle">Locations by Country</div>
    <canvas id="chartCanvas" height="90"></canvas>
  </div>

  <div class="panel">
    <table id="summaryTable">
      <thead>
        <tr><th>Key</th><th class="num">Locations</th><th class="num">Views</th><th class="num">Clicks</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://gbxxoeplkzbhsvagnfsr.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4"
    );

    let all=[], mode="country", chart=null;

    function continentFromCountry(country){
      if(!country) return "Other";
      const c=country.trim().toLowerCase();
      const m={"afghanistan":"Asia","albania":"Europe","algeria":"Africa","andorra":"Europe","angola":"Africa","antigua and barbuda":"North America","argentina":"South America","armenia":"Asia","australia":"Oceania","austria":"Europe","azerbaijan":"Asia","bahamas":"North America","bahrain":"Asia","bangladesh":"Asia","barbados":"North America","belarus":"Europe","belgium":"Europe","belize":"North America","benin":"Africa","bhutan":"Asia","bolivia":"South America","bosnia and herzegovina":"Europe","botswana":"Africa","brazil":"South America","brunei":"Asia","bulgaria":"Europe","burkina faso":"Africa","burundi":"Africa","cabo verde":"Africa","cambodia":"Asia","cameroon":"Africa","canada":"North America","central african republic":"Africa","chad":"Africa","chile":"South America","china":"Asia","colombia":"South America","comoros":"Africa","congo":"Africa","democratic republic of the congo":"Africa","costa rica":"North America","croatia":"Europe","cuba":"North America","cyprus":"Asia","czech republic":"Europe","czechia":"Europe","denmark":"Europe","djibouti":"Africa","dominica":"North America","dominican republic":"North America","ecuador":"South America","egypt":"Africa","el salvador":"North America","equatorial guinea":"Africa","eritrea":"Africa","estonia":"Europe","eswatini":"Africa","ethiopia":"Africa","fiji":"Oceania","finland":"Europe","france":"Europe","gabon":"Africa","gambia":"Africa","georgia":"Asia","germany":"Europe","ghana":"Africa","greece":"Europe","grenada":"North America","guatemala":"North America","guinea":"Africa","guinea-bissau":"Africa","guyana":"South America","haiti":"North America","honduras":"North America","hungary":"Europe","iceland":"Europe","india":"Asia","indonesia":"Asia","iran":"Asia","iraq":"Asia","ireland":"Europe","israel":"Asia","italy":"Europe","ivory coast":"Africa","jamaica":"North America","japan":"Asia","jordan":"Asia","kazakhstan":"Asia","kenya":"Africa","kiribati":"Oceania","kosovo":"Europe","kuwait":"Asia","kyrgyzstan":"Asia","laos":"Asia","latvia":"Europe","lebanon":"Asia","lesotho":"Africa","liberia":"Africa","libya":"Africa","liechtenstein":"Europe","lithuania":"Europe","luxembourg":"Europe","madagascar":"Africa","malawi":"Africa","malaysia":"Asia","maldives":"Asia","mali":"Africa","malta":"Europe","marshall islands":"Oceania","mauritania":"Africa","mauritius":"Africa","mexico":"North America","micronesia":"Oceania","moldova":"Europe","monaco":"Europe","mongolia":"Asia","montenegro":"Europe","morocco":"Africa","mozambique":"Africa","myanmar":"Asia","namibia":"Africa","nauru":"Oceania","nepal":"Asia","netherlands":"Europe","new zealand":"Oceania","nicaragua":"North America","niger":"Africa","nigeria":"Africa","north korea":"Asia","north macedonia":"Europe","norway":"Europe","oman":"Asia","pakistan":"Asia","palau":"Oceania","palestine":"Asia","panama":"North America","papua new guinea":"Oceania","paraguay":"South America","peru":"South America","philippines":"Asia","poland":"Europe","portugal":"Europe","qatar":"Asia","romania":"Europe","russia":"Europe","rwanda":"Africa","saint kitts and nevis":"North America","saint lucia":"North America","saint vincent and the grenadines":"North America","samoa":"Oceania","san marino":"Europe","sao tome and principe":"Africa","saudi arabia":"Asia","senegal":"Africa","serbia":"Europe","seychelles":"Africa","sierra leone":"Africa","singapore":"Asia","slovakia":"Europe","slovenia":"Europe","solomon islands":"Oceania","somalia":"Africa","south africa":"Africa","south korea":"Asia","south sudan":"Africa","spain":"Europe","sri lanka":"Asia","sudan":"Africa","suriname":"South America","sweden":"Europe","switzerland":"Europe","syria":"Asia","taiwan":"Asia","tajikistan":"Asia","tanzania":"Africa","thailand":"Asia","timor-leste":"Asia","togo":"Africa","tonga":"Oceania","trinidad and tobago":"North America","tunisia":"Africa","turkey":"Asia","turkmenistan":"Asia","tuvalu":"Oceania","uganda":"Africa","ukraine":"Europe","united arab emirates":"Asia","united kingdom":"Europe","united states":"North America","usa":"North America","uruguay":"South America","uzbekistan":"Asia","vanuatu":"Oceania","vatican city":"Europe","venezuela":"South America","vietnam":"Asia","yemen":"Asia","zambia":"Africa","zimbabwe":"Africa"};
      return m[c]||"Other";
    }

    async function load(){
      const { data, error } = await supabase.from("stores").select("*");
      if(error){console.error(error);return;}
      all=(data||[]).map(s=>({
        ...s,
        views:+(s.views||0),
        clicks:+(s.link_clicks||0),
        continent: s.continent || continentFromCountry(s.country)
      }));
      renderChart(); renderTable();
    }

    function aggregate(key){
      const agg=new Map();
      all.forEach(s=>{
        const k=(s[key]||"Unknown").trim();
        if(!agg.has(k)) agg.set(k,{n:0,views:0,clicks:0});
        const o=agg.get(k); o.n++; o.views+=s.views||0; o.clicks+=s.clicks||0;
      });
      return [...agg.entries()].map(([k,v])=>({k,...v})).sort((a,b)=>b.n-a.n);
    }

    function renderChart(){
      const ctx=document.getElementById("chartCanvas").getContext("2d");
      const key = mode==="country" ? "country" : mode==="continent" ? "continent" : "type";
      const data = aggregate(key).slice(0,15);
      if(chart){chart.destroy();}
      chart=new Chart(ctx,{
        type:"bar",
        data:{labels:data.map(x=>x.k),datasets:[{label:"Locations",data:data.map(x=>x.n),backgroundColor:"#2f78c4"}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
      document.getElementById("chartTitle").textContent = `Locations by ${mode[0].toUpperCase()+mode.slice(1)}`;
    }

    function renderTable(){
      const key = mode==="country" ? "country" : mode==="continent" ? "continent" : "type";
      const rows = aggregate(key).slice(0,100).map(x=>`<tr>
        <td>${x.k||"–"}</td>
        <td class="num">${x.n}</td>
        <td class="num">${x.views}</td>
        <td class="num">${x.clicks}</td>
      </tr>`).join("");
      document.querySelector("#summaryTable tbody").innerHTML = rows || `<tr><td colspan="4" style="text-align:center;color:#777;">No data</td></tr>`;
    }

    document.getElementById("btnCountry").addEventListener("click",()=>{ 
      document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
      btnCountry.classList.add("active"); mode="country"; renderChart(); renderTable();
    });
    document.getElementById("btnContinent").addEventListener("click",()=>{ 
      document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
      btnContinent.classList.add("active"); mode="continent"; renderChart(); renderTable();
    });
    document.getElementById("btnType").addEventListener("click",()=>{ 
      document.querySelectorAll(".btn").forEach(b=>b.classList.remove("active"));
      btnType.classList.add("active"); mode="type"; renderChart(); renderTable();
    });

    load();
  </script>
</body>
</html>
