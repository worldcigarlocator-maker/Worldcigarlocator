<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add / Edit Store — Backoffice</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --primary:#2f78c4; --primary-dark:#2466a8;
      --bg:#f5f6f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --green:#28a745; --warning:#b36e00;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:1.2rem;color:var(--text);}
    .topbar{display:flex;justify-content:center;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem}
    .btn{background:#fff;border:1.6px solid var(--primary);color:var(--primary);padding:.5rem .8rem;border-radius:8px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border:none}
    .btn:hover{filter:brightness(.95)}
    .wrap{max-width:950px;margin:0 auto}
    h1{text-align:center;margin:.2rem 0 1rem;color:#2b2b2b}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:1rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:.8rem}
    .full{grid-column:1/-1}
    label{font-weight:bold;font-size:.92rem}
    input[type="text"],input[type="tel"],input[type="url"]{
      width:100%;padding:.6rem;border:1px solid #ccc;border-radius:8px;font-size:.95rem
    }
    .chip-row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .chip{border:1px solid var(--border);padding:.35rem .7rem;border-radius:16px;cursor:pointer;user-select:none}
    .chip.active{background:#eef6ff;border-color:#bcd7ff;color:#145b99}
    .access-box{display:none;background:#f8fafc;border:1px dashed #cfe1ff;padding:.6rem .7rem;border-radius:8px}
    .stars{display:flex;gap:.35rem;font-size:1.6rem;cursor:pointer;color:#ccc}
    .stars .sel{color:#b8860b}
    .row{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:.86rem}
    #preview{background:#fafafa;border:1px dashed #ddd;border-radius:10px;padding:.6rem;text-align:center}
    #preview img{max-width:100%;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.12)}
    #toast-container{position:fixed;bottom:1rem;right:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:9999}
    .toast{background:#333;color:#fff;padding:.7rem 1rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2);opacity:.97}
    .toast.success{background:#28a745}.toast.error{background:#dc3545}.toast.info{background:#2f78c4}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button class="btn" onclick="window.location.href='backoffice.html'">← Tillbaka till Home</button>
    </div>

    <h1 id="formTitle">Lägg till plats (Backoffice)</h1>

    <div class="card">
      <div class="grid">
        <div class="full">
          <label>Sök med Google</label>
          <input id="gAddress" type="text" placeholder="Börja skriva ett ställe…"/>
          <div class="muted" style="margin-top:.3rem">Tips: välj i listan — fälten fylls automatiskt, inkl. foto.</div>
        </div>

        <div><label>Namn</label><input id="name" type="text"/></div>
        <div><label>Telefon</label><input id="phone" type="tel"/></div>
        <div class="full"><label>Adress</label><input id="addr" type="text"/></div>
        <div><label>Stad</label><input id="city" type="text"/></div>
        <div><label>Land</label><input id="country" type="text"/></div>
        <div class="full"><label>Webbplats</label><input id="website" type="url" placeholder="https://…"/></div>

        <div class="full">
          <label>Kategori</label>
          <div class="chip-row" id="typeRow">
            <span class="chip" data-type="store">Store</span>
            <span class="chip" data-type="lounge">Lounge</span>
            <span class="chip" data-type="other">Other</span>
          </div>
        </div>

        <div id="accessBox" class="access-box full">
          <label style="display:block;margin-bottom:.35rem;">Lounge access</label>
          <label><input type="radio" name="access" value="public"> Öppen för alla</label>&nbsp;&nbsp;
          <label><input type="radio" name="access" value="temporary"> Tillfälliga medlemmar</label>&nbsp;&nbsp;
          <label><input type="radio" name="access" value="members"> Endast medlemmar</label>
        </div>

        <div class="full">
          <label>Rating (valfri)</label>
          <div id="stars" class="stars" aria-label="Rating">
            <span data-v="1">★</span><span data-v="2">★</span><span data-v="3">★</span><span data-v="4">★</span><span data-v="5">★</span>
          </div>
        </div>

        <div class="full">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row">
              <label><input type="checkbox" id="forceDefault"> Använd standardbild</label>
              <span class="muted">Visar <code>images/store.jpg</code> och sparar utan Google-foto.</span>
            </div>
            <button class="btn" id="testPhotoBtn" type="button">Testa Google-bild</button>
          </div>
          <div id="preview" style="margin-top:.6rem"><img src="images/store.jpg" alt="Preview" /></div>
        </div>

        <div class="full" style="display:flex;gap:.6rem;justify-content:flex-end;margin-top:.4rem">
          <button class="btn" type="button" onclick="resetForm()">Rensa</button>
          <button class="btn primary" type="button" id="saveBtn" onclick="saveStore()">Spara</button>
        </div>
      </div>
    </div>
  </div>
  <div id="toast-container"></div>

  <script>
    const SUPABASE_URL = "https://gbxxoeplkzbhsvagnfsr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const GOOGLE_BROWSER_KEY = "AIzaSyDdn7E6_dfwUjGQ1IUdJ2rQXUeEYIIzVtQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const params = new URLSearchParams(window.location.search);
    const editId = params.get("edit");

    const sel = { type:"store", access:null, rating:null, lat:null, lng:null, place_id:null, photo_ref:null, photo_url:null };
    let isEdit = false;

    window.addEventListener("DOMContentLoaded", ()=>{ initUI(); if(editId) loadExisting(editId); });

    function initUI(){
      document.querySelectorAll("#typeRow .chip").forEach(c=>{
        c.addEventListener("click",()=>{
          document.querySelectorAll("#typeRow .chip").forEach(x=>x.classList.remove("active"));
          c.classList.add("active"); sel.type=c.dataset.type;
          document.getElementById("accessBox").style.display = sel.type==="lounge"?"block":"none";
          updatePreview();
        });
      });
      document.querySelectorAll("input[name='access']").forEach(r=>r.addEventListener("change",()=>sel.access=r.value));
      document.getElementById("forceDefault").addEventListener("change", updatePreview);
      const stars=document.getElementById("stars");
      stars.addEventListener("click",e=>{
        const v=+e.target.dataset.v;if(!v)return;sel.rating=v;[...stars.children].forEach((el,i)=>el.classList.toggle("sel",i<v));
      });
      document.getElementById("testPhotoBtn").addEventListener("click",()=>{
        if(sel.photo_ref){ sel.photo_url=photoUrlFromRef(sel.photo_ref); updatePreview(true); showToast("Försöker ladda Google-bild…","info"); }
        else showToast("Ingen Google-fotoreferens ännu.","error");
      });
    }

    async function loadExisting(id){
      const { data, error } = await supabase.from("stores").select("*").eq("id", id).single();
      if(error||!data){ showToast("Kunde inte ladda posten","error"); return; }
      isEdit = true;
      document.getElementById("formTitle").textContent = "Redigera plats";
      document.getElementById("saveBtn").textContent = "Uppdatera";
      document.getElementById("name").value = data.name||"";
      document.getElementById("addr").value = data.address||"";
      document.getElementById("city").value = data.city||"";
      document.getElementById("country").value = data.country||"";
      document.getElementById("phone").value = data.phone||"";
      document.getElementById("website").value = data.website||"";
      sel.type = data.type||"store";
      sel.access = data.access||null;
      sel.rating = data.rating||null;
      sel.lat = data.lat; sel.lng = data.lng;
      sel.place_id = data.place_id; sel.photo_ref = data.photo_reference; sel.photo_url = data.photo_url;
      document.querySelectorAll("#typeRow .chip").forEach(c=>c.classList.toggle("active",c.dataset.type===sel.type));
      document.getElementById("accessBox").style.display = sel.type==="lounge"?"block":"none";
      if(sel.access){ document.querySelector(`input[name='access'][value='${sel.access}']`)?.click(); }
      if(sel.rating){ [...document.getElementById("stars").children].forEach((el,i)=>el.classList.toggle("sel",i<sel.rating)); }
      updatePreview();
      showToast("Redigeringsläge","info");
    }

    function photoUrlFromRef(ref){ return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photo_reference=${encodeURIComponent(ref)}&key=${GOOGLE_BROWSER_KEY}`; }
    function currentImageUrl(){ if(document.getElementById("forceDefault").checked)return"images/store.jpg"; if(sel.photo_url?.startsWith("http"))return sel.photo_url; if(sel.photo_ref)return photoUrlFromRef(sel.photo_ref); return"images/store.jpg"; }
    function updatePreview(){ document.getElementById("preview").innerHTML=`<img src="${currentImageUrl()}" alt="Preview" onerror="this.src='images/store.jpg'">`; }

    async function saveStore(){
      const payload = {
        name:document.getElementById("name").value.trim(),
        address:document.getElementById("addr").value.trim(),
        city:document.getElementById("city").value.trim(),
        country:document.getElementById("country").value.trim(),
        phone:document.getElementById("phone").value.trim(),
        website:document.getElementById("website").value.trim(),
        type:sel.type, types:[sel.type], access:sel.access,
        rating:sel.rating??null, lat:sel.lat, lng:sel.lng,
        place_id:sel.place_id, photo_reference:sel.photo_ref, photo_url:sel.photo_url
      };
      if(!payload.name||!payload.address||!payload.city||!payload.country){showToast("Fyll i namn, adress, stad och land.","error");return;}

      if(isEdit){
        const { error } = await supabase.from("stores").update(payload).eq("id", editId);
        if(error){showToast("Fel vid uppdatering","error");return;}
        showToast("✅ Uppdaterad","success");
      }else{
        payload.approved=false;payload.status="pending";
        const { error } = await supabase.from("stores").insert([payload]);
        if(error){showToast("Fel vid sparning","error");return;}
        showToast("✅ Sparad","success");
      }
    }

    function resetForm(){document.querySelectorAll("input").forEach(i=>i.value="");document.getElementById("forceDefault").checked=false;sel.type="store";sel.access=null;sel.rating=null;sel.lat=sel.lng=null;updatePreview();showToast("Formulär rensat","success");}
    function showToast(msg,type="info"){const c=document.getElementById("toast-container");const t=document.createElement("div");t.className=`toast ${type}`;t.textContent=msg;c.appendChild(t);setTimeout(()=>t.remove(),3000);}
  </script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDdn7E6_dfwUjGQ1IUdJ2rQXUeEYIIzVtQ&libraries=places&callback=initAutocomplete"></script>
</body>
</html>
