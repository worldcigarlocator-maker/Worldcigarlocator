<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Backoffice — Business Analytics (Final)</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      /* Excel-inspired palette */
      --primary:#2f78c4;      /* buttons/lines */
      --primary-dark:#2466a8;
      --accent:#1d8348;       /* active KPI green */
      --accent-light:#28a745;
      --bg:#f8f8f8;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --border:#e5e5e5;
    }
    *{box-sizing:border-box}
    /* 35% compact: base font down from ~16px → ~10.5px */
    body{font-family:Arial, sans-serif;background:var(--bg);margin:0;padding:1.3rem;color:var(--text);font-size:11px;}

    h1{color:#2b2b2b;text-align:center;margin:0 0 .9rem;font-size:1.45rem}

    /* Top bar with Home + Search */
    nav{display:flex;justify-content:center;align-items:center;gap:.45rem;flex-wrap:wrap;margin:0 0 .9rem}
    nav a{
      background:#fff;border:1.6px solid var(--primary);color:var(--primary);
      padding:.35rem .55rem;border-radius:8px;font-weight:700;text-decoration:none;font-size:.95rem
    }
    nav a:hover{background:var(--primary);color:#fff}
    #searchInput{
      padding:.38rem .6rem;border:1.6px solid var(--primary);border-radius:8px;font-size:.95rem;max-width:280px;width:100%;
    }
    #searchInput:focus{outline:none;box-shadow:0 0 4px rgba(47,120,196,.35)}

    /* KPI grid — compact */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.7rem;margin-bottom:.9rem}
    .stat-card{
      background:var(--card);border:1px solid var(--border);border-radius:10px;
      box-shadow:0 1px 4px rgba(0,0,0,.06);padding:.7rem;text-align:center;cursor:pointer;
      transition:transform .12s, box-shadow .12s, background .12s, color .12s
    }
    .stat-card:hover{transform:translateY(-2px);box-shadow:0 3px 10px rgba(0,0,0,.1)}
    .stat-card.active{background:var(--accent-light);color:#fff;border-color:transparent}
    .stat-card h2{margin:.05rem 0 .15rem;font-size:1.45rem;color:inherit}
    .stat-card p{margin:0;color:inherit;opacity:.9;font-size:.95rem}

    /* Panels and controls */
    .panel{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:.7rem;margin-bottom:.7rem}
    .row{display:flex;flex-wrap:wrap;gap:.4rem;align-items:center;justify-content:center}

    .btn{
      background:#fff;border:1.6px solid var(--primary);color:var(--primary);
      padding:.38rem .6rem;border-radius:8px;font-weight:700;cursor:pointer;font-size:.95rem
    }
    .btn:hover{background:var(--primary);color:#fff}
    .btn.active{background:var(--primary);color:#fff}

    /* Primary action: Show/Hide in blue block style */
    #toggleCharts{
      background:var(--primary);color:#fff;border:none;
      padding:.42rem .7rem;border-radius:8px;font-weight:800
    }
    #toggleCharts:hover{background:var(--primary-dark);color:#fff}

    .select{
      border:1.6px solid var(--primary);border-radius:8px;padding:.35rem .55rem;
      color:var(--primary);background:#fff;font-weight:700;font-size:.95rem
    }

    .chart-title{color:#2b2b2b;font-weight:800;text-align:center;margin:.45rem 0 0;font-size:1.05rem}
    .chart-wrap{position:relative;padding:.6rem}
    /* No animations → static */

    /* Table */
    .table-wrap{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.06);overflow:hidden}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem .7rem;border-bottom:1px solid #eee;text-align:left;font-size:.95rem}
    th{background:#f3f3f3;color:#333;cursor:pointer;user-select:none}
    tr:hover{background:#f9fafb}
    td.num{text-align:center}
    .status{font-weight:700}
    .approved{color:#1d8348}.flagged{color:#c0392b}.pending{color:#bd8b00}

    /* Export bar */
    .export-bar{display:flex;flex-wrap:wrap;gap:.5rem;margin:.7rem 0;justify-content:center}
    .export-bar button{
      background:var(--primary);color:#fff;border:none;padding:.42rem .7rem;border-radius:8px;font-weight:700;cursor:pointer;font-size:.95rem
    }
    .export-bar button.secondary{background:#fff;color:var(--primary);border:1.6px solid var(--primary)}
    .export-bar button:hover{opacity:.96}
  </style>
</head>
<body>
  <h1>World Cigar Locator — Backoffice</h1>

  <nav>
    <a href="backoffice-home.html">Home</a>
    <input id="searchInput" placeholder="Search by name, city or country..." />
  </nav>

  <!-- KPI CARDS (clickable filters/sorts) -->
  <div class="stats-grid" id="kpiGrid">
    <div class="stat-card" data-kpi="all"><h2 id="kpiTotal">–</h2><p>Total Locations</p></div>
    <div class="stat-card" data-kpi="approved"><h2 id="kpiApproved">–</h2><p>Approved</p></div>
    <div class="stat-card" data-kpi="pending"><h2 id="kpiPending">–</h2><p>Pending</p></div>
    <div class="stat-card" data-kpi="flagged"><h2 id="kpiFlagged">–</h2><p>Flagged</p></div>
    <div class="stat-card" data-kpi="deleted"><h2 id="kpiDeleted">–</h2><p>Deleted</p></div>
    <div class="stat-card" data-kpi="views"><h2 id="kpiViews">Top</h2><p>Most Views</p></div>
    <div class="stat-card" data-kpi="clicks"><h2 id="kpiClicks">Top</h2><p>Most Clicks</p></div>
    <div class="stat-card" data-kpi="ctr"><h2 id="kpiCtr">Top</h2><p>Top CTR</p></div>
    <div class="stat-card" data-kpi="newmonth"><h2 id="kpiNewMonth">–</h2><p>New This Month</p></div>
  </div>

  <!-- CHARTS PANEL -->
  <div class="panel">
    <div class="row" style="margin-bottom:.4rem">
      <button class="btn" id="toggleCharts">Show Charts</button>
      <select class="select" id="periodSelect">
        <option value="7">Last 7 Days</option>
        <option value="30" selected>Last 30 Days</option>
        <option value="365">Last 12 Months</option>
      </select>
      <button class="btn active" id="btnCountry">Performance per Country</button>
      <button class="btn" id="btnType">Performance per Type</button>
      <button class="btn" id="btnNewCards">New Cards per Country</button>
    </div>
    <div class="chart-title" id="chartTitle">Performance per Country</div>
    <div class="chart-wrap">
      <canvas id="chartCanvas" height="85"></canvas>
    </div>
  </div>

  <!-- TABLE -->
  <div class="table-wrap">
    <table id="storesTable">
      <thead>
        <tr>
          <th data-sort="name">Name</th>
          <th data-sort="country">Country</th>
          <th data-sort="types">Type</th>
          <th data-sort="views">Views</th>
          <th data-sort="clicks">Link Clicks</th>
          <th data-sort="ctr">CTR (%)</th>
          <th data-sort="rating">Rating</th>
          <th data-sort="status">Status</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- EXPORT -->
  <div class="export-bar">
    <button id="expAllCsv">Export ALL → CSV</button>
    <button id="expAllXlsx" class="secondary">Export ALL → Excel</button>
    <button id="expFilteredCsv">Export FILTERED → CSV</button>
    <button id="expFilteredXlsx" class="secondary">Export FILTERED → Excel</button>
    <button id="expGrowthCsv">Export GROWTH DATA → CSV</button>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const supabase = createClient(
    "https://gbxxoeplkzbhsvagnfsr.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4"
  );

  // Excel palette for charts
  const cStores = "#2f78c4";   // blue
  const cViews  = "#72c472";   // light green
  const cClicks = "#1d8348";   // dark green
  const cNew    = "#46a5e5";   // light blue line

  const kpiEls = {
    total: document.getElementById("kpiTotal"),
    approved: document.getElementById("kpiApproved"),
    pending: document.getElementById("kpiPending"),
    flagged: document.getElementById("kpiFlagged"),
    deleted: document.getElementById("kpiDeleted"),
    views: document.getElementById("kpiViews"),
    clicks: document.getElementById("kpiClicks"),
    ctr: document.getElementById("kpiCtr"),
    newMonth: document.getElementById("kpiNewMonth"),
  };

  const tableBody = document.getElementById("tableBody");
  const chartTitle = document.getElementById("chartTitle");
  const canvas = document.getElementById("chartCanvas");
  const ctx = canvas.getContext("2d");

  const toggleChartsBtn = document.getElementById("toggleCharts");
  const btnCountry = document.getElementById("btnCountry");
  const btnType = document.getElementById("btnType");
  const btnNew = document.getElementById("btnNewCards");
  const periodSelect = document.getElementById("periodSelect");
  const kpiGrid = document.getElementById("kpiGrid");
  const searchInput = document.getElementById("searchInput");

  let allStores = [];
  let currentFilter = "all";         // all, approved, pending, flagged, deleted, newmonth
  let currentSortMode = "none";      // none, views, clicks, ctr
  let currentChart = "country";      // country, type, new
  let chartInstance = null;
  let chartsVisible = false;         // start hidden
  let searchQuery = "";

  await loadData();
  renderKPIs();
  renderTable();
  // charts hidden until toggled; canvas remains but empty

  function normalize(s){
    return {
      ...s,
      views: Number(s.views || 0),
      link_clicks: Number(s.link_clicks || 0),
      rating: Number(s.rating || 0),
      types: Array.isArray(s.types) ? s.types : (s.type ? [s.type] : []),
      statusNorm: s.status || (s.approved ? "approved" : "pending"),
      created_at: s.created_at,
      name: s.name || "",
      city: s.city || "",
      country: s.country || ""
    };
  }

  async function loadData(){
    const { data, error } = await supabase.from("stores").select("*");
    if (error) { allStores=[]; return; }
    allStores = (data || []).map(normalize);
  }

  function daysAgo(n){ const d = new Date(); d.setDate(d.getDate()-n); return d; }

  function renderKPIs(){
    const total = allStores.length;
    const approved = allStores.filter(s => !!s.approved).length;
    const pending = allStores.filter(s => !s.approved && s.status !== "deleted").length;
    const flagged = allStores.filter(s => !!s.flagged).length;
    const deleted = allStores.filter(s => s.status === "deleted").length;
    const cutoff = daysAgo(30);
    const newMonth = allStores.filter(s => new Date(s.created_at)>=cutoff).length;

    kpiEls.total.textContent = total;
    kpiEls.approved.textContent = approved;
    kpiEls.pending.textContent = pending;
    kpiEls.flagged.textContent = flagged;
    kpiEls.deleted.textContent = deleted;
    kpiEls.newMonth.textContent = newMonth;
    // "Top" labels already set for views/clicks/ctr as these are sorters, not counts
  }

  function applySearch(arr){
    if (!searchQuery) return arr;
    const q = searchQuery.toLowerCase();
    return arr.filter(s =>
      (s.name && s.name.toLowerCase().includes(q)) ||
      (s.city && s.city.toLowerCase().includes(q)) ||
      (s.country && s.country.toLowerCase().includes(q))
    );
  }

  function filtered(){
    let base = allStores.slice();
    // KPI filter
    if (currentFilter === "approved") base = base.filter(s => !!s.approved && s.status !== "deleted");
    if (currentFilter === "pending")  base = base.filter(s => !s.approved && s.status !== "deleted");
    if (currentFilter === "flagged")  base = base.filter(s => !!s.flagged && s.status !== "deleted");
    if (currentFilter === "deleted")  base = base.filter(s => s.status === "deleted");
    if (currentFilter === "newmonth") {
      const cut = daysAgo(30);
      base = base.filter(s => new Date(s.created_at) >= cut);
    }
    // Search
    base = applySearch(base);
    // Sort mode
    if (currentSortMode === "views") base.sort((a,b)=>(b.views||0)-(a.views||0));
    if (currentSortMode === "clicks") base.sort((a,b)=>(b.link_clicks||0)-(a.link_clicks||0));
    if (currentSortMode === "ctr") {
      const c = s => (s.views>0 ? (s.link_clicks||0)/s.views : 0);
      base.sort((a,b)=> c(b)-c(a));
    }
    return base;
  }

  function renderTable(){
    const rows = filtered().slice(0,500);
    tableBody.innerHTML = rows.map(s=>{
      const typesStr = s.types && s.types.length ? s.types.join(" & ") : (s.type || "–");
      const views = s.views||0;
      const clicks = s.link_clicks||0;
      const ctr = views>0 ? ((clicks/views)*100).toFixed(1) : "0.0";
      const statusClass = s.flagged ? "flagged" : s.approved ? "approved" : (s.status==="deleted" ? "" : "pending");
      const statusText = s.flagged ? "Flagged" : s.approved ? "Approved" : (s.status==="deleted" ? "Deleted" : "Pending");
      return `
        <tr>
          <td>${esc(s.name||"–")}</td>
          <td>${esc(s.country||"–")}</td>
          <td>${esc(typesStr)}</td>
          <td class="num">${views}</td>
          <td class="num">${clicks}</td>
          <td class="num">${ctr}</td>
          <td class="num">${s.rating||0}</td>
          <td class="status ${statusClass}">${statusText}</td>
        </tr>
      `;
    }).join("");
  }

  function buildAggCountry(){
    const data = filtered();
    const map = new Map();
    for (const s of data){
      const c = (s.country||"Unknown").trim();
      if (!map.get(c)) map.set(c,{stores:0,views:0,clicks:0});
      const o = map.get(c);
      o.stores += 1;
      o.views  += s.views||0;
      o.clicks += s.link_clicks||0;
    }
    const arr = Array.from(map.entries())
      .sort((a,b)=> (b[1].stores + b[1].views + b[1].clicks) - (a[1].stores + a[1].views + a[1].clicks))
      .slice(0,20);
    return {
      labels: arr.map(e=>e[0]),
      stores: arr.map(e=>e[1].stores),
      views:  arr.map(e=>e[1].views),
      clicks: arr.map(e=>e[1].clicks),
    };
  }

  function buildAggType(){
    const data = filtered();
    const map = new Map();
    for (const s of data){
      const types = (s.types && s.types.length) ? s.types : (s.type ? [s.type] : ["other"]);
      for (const tRaw of types){
        const t = tRaw.toLowerCase();
        if (!map.get(t)) map.set(t,{stores:0,views:0,clicks:0});
        const o = map.get(t);
        o.stores += 1;
        o.views  += s.views||0;
        o.clicks += s.link_clicks||0;
      }
    }
    const arr = Array.from(map.entries())
      .sort((a,b)=> (b[1].stores + b[1].views + b[1].clicks) - (a[1].stores + a[1].views + a[1].clicks));
    return {
      labels: arr.map(e=>cap(e[0])),
      stores: arr.map(e=>e[1].stores),
      views:  arr.map(e=>e[1].views),
      clicks: arr.map(e=>e[1].clicks),
    };
  }

  function buildGrowthCountry(days){
    const cut = daysAgo(days);
    const data = filtered().filter(s => new Date(s.created_at) >= cut);
    const map = new Map();
    for (const s of data){
      const c = (s.country||"Unknown").trim();
      map.set(c,(map.get(c)||0)+1);
    }
    const arr = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]).slice(0,20);
    return { labels: arr.map(e=>e[0]), values: arr.map(e=>e[1]) };
  }

  function renderChart(){
    if (!chartsVisible) return;
    if (chartInstance){ chartInstance.destroy(); chartInstance = null; }

    if (currentChart === "country"){
      const agg = buildAggCountry();
      chartTitle.textContent = "Performance per Country";
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: agg.labels,
          datasets: [
            { label: 'Stores', data: agg.stores, backgroundColor: cStores },
            { label: 'Views',  data: agg.views,  backgroundColor: cViews },
            { label: 'Clicks', data: agg.clicks, backgroundColor: cClicks }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { grid:{display:false}, barPercentage:0.4, categoryPercentage:0.5 },
            y: { beginAtZero:true, grid:{color:"#eee"} }
          },
          plugins: { legend: { position: 'top' } }
        }
      });
    } else if (currentChart === "type"){
      const agg = buildAggType();
      chartTitle.textContent = "Performance per Type";
      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: agg.labels,
          datasets: [
            { label: 'Stores', data: agg.stores, backgroundColor: cStores },
            { label: 'Views',  data: agg.views,  backgroundColor: cViews },
            { label: 'Clicks', data: agg.clicks, backgroundColor: cClicks }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { grid:{display:false}, barPercentage:0.4, categoryPercentage:0.5 },
            y: { beginAtZero:true, grid:{color:"#eee"} }
          },
          plugins: { legend: { position: 'top' } }
        }
      });
    } else {
      const days = Number(periodSelect.value||30);
      const growth = buildGrowthCountry(days);
      chartTitle.textContent = "New Cards per Country";
      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: growth.labels,
          datasets: [
            { label: 'New Cards', data: growth.values, borderColor: cNew, backgroundColor: cNew, fill:false, tension:.25 }
          ]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, grid:{color:"#eee"} }, x:{ grid:{display:false} } },
          plugins: { legend: { position: 'top' } }
        }
      });
    }
  }

  function esc(str){ return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function cap(s){ return s ? (s.charAt(0).toUpperCase()+s.slice(1)) : s; }

  // Chart controls
  [btnCountry, btnType, btnNew].forEach(btn=>{
    btn.addEventListener("click", ()=>{
      [btnCountry, btnType, btnNew].forEach(x=>x.classList.remove("active"));
      btn.classList.add("active");
      if (btn === btnCountry) currentChart = "country";
      if (btn === btnType) currentChart = "type";
      if (btn === btnNew) currentChart = "new";
      renderChart();
    });
  });
  periodSelect.addEventListener("change", ()=> { if (currentChart === "new") renderChart(); });
  toggleChartsBtn.addEventListener("click", ()=>{
    chartsVisible = !chartsVisible;
    toggleChartsBtn.textContent = chartsVisible ? "Hide Charts" : "Show Charts";
    renderChart();
  });

  // KPI click logic (filters/sorts)
  const kpiCards = Array.from(kpiGrid.querySelectorAll(".stat-card"));
  kpiCards.forEach(card=>{
    card.addEventListener("click", ()=>{
      const k = card.dataset.kpi;
      const wasActive = card.classList.contains("active");
      kpiCards.forEach(c=>c.classList.remove("active"));

      if (wasActive){ // reset
        currentFilter = "all";
        currentSortMode = "none";
      } else {
        card.classList.add("active");
        if (k === "all"){ currentFilter="all"; currentSortMode="none"; }
        if (k === "approved"){ currentFilter="approved"; currentSortMode="none"; }
        if (k === "pending"){ currentFilter="pending"; currentSortMode="none"; }
        if (k === "flagged"){ currentFilter="flagged"; currentSortMode="none"; }
        if (k === "deleted"){ currentFilter="deleted"; currentSortMode="none"; }
        if (k === "newmonth"){ currentFilter="newmonth"; currentSortMode="none"; }
        if (k === "views"){ currentFilter="all"; currentSortMode="views"; }
        if (k === "clicks"){ currentFilter="all"; currentSortMode="clicks"; }
        if (k === "ctr"){ currentFilter="all"; currentSortMode="ctr"; }
      }
      renderTable();
      renderChart();
    });
  });

  // Search (top bar)
  searchInput.addEventListener("input", ()=>{
    searchQuery = searchInput.value.trim();
    renderTable();
    renderChart();
  });

  // Table sorting (by header click)
  let sortKey=null, sortDir=1;
  Array.from(document.querySelectorAll('#storesTable thead th')).forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.sort;
      if (!key) return;
      if (sortKey === key) sortDir *= -1; else { sortKey=key; sortDir=1; }
      const rows = Array.from(tableBody.querySelectorAll('tr'));
      const idxMap = { name:0, country:1, types:2, views:3, clicks:4, ctr:5, rating:6, status:7 };
      rows.sort((a,b)=>{
        const A = a.children[idxMap[key]].textContent.trim();
        const B = b.children[idxMap[key]].textContent.trim();
        const aNum = parseFloat(A), bNum = parseFloat(B);
        if (!isNaN(aNum) && !isNaN(bNum)) return (aNum - bNum)*sortDir;
        return A.localeCompare(B)*sortDir;
      });
      rows.forEach(r=>tableBody.appendChild(r));
    });
  });

  // Exports
  document.getElementById("expAllCsv").addEventListener("click", ()=> exportCSV(allStores, "stores_all.csv"));
  document.getElementById("expAllXlsx").addEventListener("click", ()=> exportXLSX(allStores, "stores_all.xlsx"));
  document.getElementById("expFilteredCsv").addEventListener("click", ()=> exportCSV(filtered(), `stores_filtered.csv`));
  document.getElementById("expFilteredXlsx").addEventListener("click", ()=> exportXLSX(filtered(), `stores_filtered.xlsx`));
  document.getElementById("expGrowthCsv").addEventListener("click", ()=>{
    const days = Number(periodSelect.value||30);
    const growth = buildGrowthCountry(days);
    const rows = growth.labels.map((c,i)=>({ country:c, new_cards:growth.values[i], period_days:days }));
    exportCSVRows(rows, `growth_by_country_${days}d.csv`);
  });

  function exportCSV(rows, filename){
    const data = rows.map(s=>({
      id: s.id,
      name: s.name||"",
      city: s.city||"",
      country: s.country||"",
      types: (s.types && s.types.length ? s.types.join(" & ") : (s.type||"")),
      views: s.views||0,
      link_clicks: s.link_clicks||0,
      ctr_percent: (s.views>0 ? ((s.link_clicks||0)/s.views*100).toFixed(1) : "0.0"),
      rating: s.rating||0,
      approved: !!s.approved,
      flagged: !!s.flagged,
      status: s.status||"",
      created_at: s.created_at||""
    }));
    exportCSVRows(data, filename);
  }
  function exportCSVRows(data, filename){
    const headers = Object.keys(data[0] || {notice:"no data"});
    const csv = [headers.join(",")]
      .concat(data.map(r=>headers.map(h=>csvEsc(r[h])).join(",")))
      .join("\n");
    downloadBlob(new Blob([csv], {type:"text/csv;charset=utf-8;"}), filename);
  }
  function csvEsc(v){
    const s = String(v ?? "");
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }
  function exportXLSX(rows, filename){
    const data = rows.map(s=>({
      id: s.id,
      name: s.name||"",
      city: s.city||"",
      country: s.country||"",
      types: (s.types && s.types.length ? s.types.join(" & ") : (s.type||"")),
      views: s.views||0,
      link_clicks: s.link_clicks||0,
      ctr_percent: (s.views>0 ? ((s.link_clicks||0)/s.views*100).toFixed(1) : "0.0"),
      rating: s.rating||0,
      approved: !!s.approved,
      flagged: !!s.flagged,
      status: s.status||"",
      created_at: s.created_at||""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "stores");
    XLSX.writeFile(wb, filename);
  }
  function downloadBlob(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
</script>
</body>
</html>
