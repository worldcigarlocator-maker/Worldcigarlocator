<!-- approved.html — Backoffice Approved (dynamic continent totals with global state hierarchy) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backoffice — Approved</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary:#2f78c4; --primary-dark:#2466a8;
      --bg:#f5f6f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --pill:#e8f1fb; --pilltext:#1a5fa5; --danger:#c0392b; --success:#1d8348;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:1rem;color:var(--text);font-size:14px}
    h1{text-align:center;margin:0 0 1rem;color:#2b2b2b}
    .wrap{max-width:1100px;margin:0 auto}
    .topbar{display:flex;justify-content:center;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}
    .btn{background:#fff;border:1.6px solid var(--primary);color:var(--primary);padding:.45rem .8rem;border-radius:8px;font-weight:800;cursor:pointer;transition:filter .2s}
    .btn.primary{background:var(--primary);color:#fff;border:none}
    .btn:hover{filter:brightness(.95)}
    .searchbar{display:flex;gap:.5rem;justify-content:center;margin-bottom:1rem;flex-wrap:wrap}
    .input{border:1.6px solid var(--primary);border-radius:8px;padding:.45rem .7rem;min-width:260px}
    .muted{color:var(--muted)}
    .section{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:.6rem}
    .section-header{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;cursor:pointer;user-select:none;transition:background .2s}
    .section-header:hover{background:#f8fbff}
    .chev{font-weight:900;color:var(--primary-dark);transition:transform .25s ease}
    .section-header.open .chev{transform:rotate(90deg)}
    .pill{background:var(--pill);color:var(--pilltext);padding:.15rem .5rem;border-radius:999px;font-weight:800;font-size:.8rem}
    .section-body{padding:.3rem .8rem .8rem;display:none}
    .section-body.open{display:block}
    .continent-summary{font-weight:600;color:var(--muted);margin:.3rem 0 .8rem 2rem;font-size:.9rem;}

    .row{display:flex;justify-content:space-between;align-items:center;padding:.45rem .6rem;border:1px solid var(--border);border-radius:8px;margin:.35rem 0;background:#fff;cursor:pointer;transition:background .15s}
    .row:hover{background:#f9fbff}
    .row-title{display:flex;align-items:center;gap:.5rem}
    .indent-1{margin-left:1.2rem}
    .indent-2{margin-left:2.0rem}
    .indent-3{margin-left:2.8rem}

    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border-bottom:1px solid #eee;padding:.5rem;text-align:left}
    th{background:#f3f4f6;font-weight:800}
    td.num{text-align:center}

    #toast-container{position:fixed;bottom:1rem;right:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:9999}
    .toast{background:#333;color:#fff;padding:.7rem 1rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2);opacity:.97}
    .toast.success{background:#28a745}.toast.error{background:#dc3545}.toast.info{background:#2f78c4}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button class="btn" onclick="window.location.href='backoffice.html'">← Back to Home</button>
      <button class="btn" onclick="window.location.href='add-store-backoffice.html'">+ Add Store</button>
    </div>

    <h1>Approved Stores</h1>

    <div class="searchbar">
      <input id="search" class="input" type="text" placeholder="Search: name / city / state / country / website…"/>
      <button class="btn" onclick="doSearch()">Search</button>
      <button class="btn" onclick="clearSearch()">Clear</button>
      <span class="muted" id="searchMeta"></span>
    </div>

    <div id="hierarchy"></div>
  </div>

  <div id="toast-container"></div>

  <script>
    const SUPABASE_URL = "https://gbxxoeplkzbhsvagnfsr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let all = [];
    let searchQ = "";

    function showToast(msg,type="info"){
      const c=document.getElementById("toast-container");
      const t=document.createElement("div");
      t.className=`toast ${type}`;t.textContent=msg;c.appendChild(t);
      setTimeout(()=>t.remove(),3200);
    }

    function esc(s){return String(s??"").replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));}

    (async function init(){
      const {data,error}=await supabase.from("stores").select("*").eq("approved",true).eq("deleted",false);
      if(error){showToast(error.message,"error");return;}
      all=data||[];
      renderHierarchy();
    })();

    function doSearch(){searchQ=document.getElementById("search").value.trim();renderHierarchy();}
    function clearSearch(){document.getElementById("search").value="";searchQ="";renderHierarchy();}

    function matchesSearch(s){
      if(!searchQ)return true;
      const q=searchQ.toLowerCase();
      return [s.name,s.city,s.state,s.country,s.website].some(v=>(v||"").toLowerCase().includes(q));
    }

    function groupData(rows){
      const src=searchQ?rows.filter(matchesSearch):rows;
      const byContinent=new Map();
      for(const s of src){
        const cont=s.continent||getContinent(s.country);
        if(!byContinent.has(cont))byContinent.set(cont,new Map());
        const byCountry=byContinent.get(cont);
        const cc=(s.country||"Unknown").trim();
        if(!byCountry.has(cc))byCountry.set(cc,new Map());
        const byState=byCountry.get(cc);
        const st=(s.state||"–").trim();
        if(!byState.has(st))byState.set(st,new Map());
        const city=(s.city||"Unknown").trim();
        if(!byState.get(st).has(city))byState.get(st).set(city,[]);
        byState.get(st).get(city).push(s);
      }
      return byContinent;
    }

    function getContinent(country){
      const c=String(country||"").toLowerCase();
      if(["sweden","germany","italy","france","spain","norway","finland","denmark"].includes(c))return"Europe";
      if(["united states","canada","mexico"].includes(c))return"North America";
      if(["brazil","argentina","chile"].includes(c))return"South America";
      if(["china","japan","india","thailand"].includes(c))return"Asia";
      if(["south africa","nigeria","kenya"].includes(c))return"Africa";
      if(["australia","new zealand"].includes(c))return"Oceania";
      return"Other";
    }

    function renderHierarchy(){
      const root=document.getElementById("hierarchy");root.innerHTML="";
      const grouped=groupData(all);
      for(const [continent,countries]of grouped){
        const contCount=[...countries.values()].reduce((a,c)=>a+[...c.values()].reduce((b,s)=>b+[...s.values()].reduce((d,e)=>d+e.length,0),0),0);
        const sec=document.createElement("div");
        sec.className="section";
        sec.innerHTML=`<div class='section-header'><div class='chev'>▸</div><div style='font-weight:900'>${esc(continent)}</div><span class='pill'>${contCount}</span></div><div class='section-body'></div><div class='continent-summary'>Total in ${esc(continent)}: ${contCount} stores</div>`;
        root.appendChild(sec);
        const header=sec.querySelector(".section-header"),body=sec.querySelector(".section-body");
        header.addEventListener("click",()=>{body.classList.toggle("open");header.classList.toggle("open");if(body.classList.contains("open"))renderCountries(countries,body);else body.innerHTML="";});
      }
      document.getElementById("searchMeta").textContent = searchQ ? `Filtered view: ${all.filter(matchesSearch).length} results` : `Total: ${all.length} stores`;
    }

    function renderCountries(countries,wrap){
      wrap.innerHTML="";
      for(const [countryName,states]of countries){
        const count=[...states.values()].reduce((a,c)=>a+[...c.values()].reduce((b,e)=>b+e.length,0),0);
        const row=document.createElement("div");
        row.className="row indent-1";
        row.innerHTML=`<div class='row-title'><div class='chev'>▸</div><div style='font-weight:800'>${esc(countryName)}</div><span class='pill'>${count}</span></div>`;
        wrap.appendChild(row);
        const levelWrap=document.createElement("div");levelWrap.style.display="none";wrap.appendChild(levelWrap);
        row.addEventListener("click",()=>{const open=levelWrap.style.display==="block";levelWrap.style.display=open?"none":"block";row.querySelector(".chev").style.transform=open?"rotate(0deg)":"rotate(90deg)";if(!open)renderStates(states,levelWrap,countryName);});
      }
    }

    function renderStates(states,wrap,countryName){
      wrap.innerHTML="";
      for(const [stateName,cities]of states){
        const count=[...cities.values()].reduce((a,b)=>a+b.length,0);
        const sRow=document.createElement("div");sRow.className="row indent-2";
        sRow.innerHTML=`<div class='row-title'><div class='chev'>▸</div><div style='font-weight:800'>${esc(stateName==="–"?"(No State)":stateName)}</div><span class='pill'>${count}</span></div>`;
        wrap.appendChild(sRow);
        const cityWrap=document.createElement("div");cityWrap.style.display="none";wrap.appendChild(cityWrap);
        sRow.addEventListener("click",()=>{const open=cityWrap.style.display==="block";cityWrap.style.display=open?"none":"block";sRow.querySelector(".chev").style.transform=open?"rotate(0deg)":"rotate(90deg)";if(!open)renderCities(cities,cityWrap,countryName,stateName);});
      }
    }

    function renderCities(cities,wrap,countryName,stateName){
      wrap.innerHTML="";
      for(const [cityName,stores]of cities){
        const ctRow=document.createElement("div");ctRow.className="row indent-3";
        ctRow.innerHTML=`<div class='row-title'><div class='chev'>▸</div><div style='font-weight:800'>${esc(cityName)}</div><span class='pill'>${stores.length}</span></div>`;
        wrap.appendChild(ctRow);
        const tableWrap=document.createElement("div");tableWrap.style.display="none";wrap.appendChild(tableWrap);
        ctRow.addEventListener("click",()=>{const open=tableWrap.style.display==="block";tableWrap.style.display=open?"none":"block";ctRow.querySelector(".chev").style.transform=open?"rotate(0deg)":"rotate(90deg)";if(!open)renderStoreTable(stores,tableWrap);});
      }
    }

    function renderStoreTable(stores,wrap){
      wrap.innerHTML=`<table><thead><tr><th>Name</th><th>City</th><th>State</th><th>Country</th><th>Types</th><th>Website</th><th class='num'>Rating</th></tr></thead><tbody></tbody></table>`;
      const tbody=wrap.querySelector("tbody");
      for(const s of stores){
        const tr=document.createElement("tr");
        tr.innerHTML=`<td>${esc(s.name||"–")}</td><td>${esc(s.city||"–")}</td><td>${esc(s.state||"")}</td><td>${esc(s.country||"–")}</td><td>${esc((s.types&&s.types.length?s.types.join(" & "):(s.type||"–")))}</td><td>${s.website?`<a href='${esc(s.website)}' target='_blank'>Open</a>`:'—'}</td><td class='num'>${s.rating??0}</td>`;
        tbody.appendChild(tr);
      }
    }
  </script>
</body>
</html>
