<!-- approved.html ‚Äî Approved list with Region/Land groups, State column (USA), inline edit -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Approved ‚Äî Backoffice</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --primary:#2f78c4; --primary-dark:#2466a8;
      --bg:#f5f6f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --green:#1d8348; --red:#c0392b; --row:#f9fafb;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:1rem;color:var(--text)}
    h1{margin:.2rem 0 1rem;text-align:center;color:#2b2b2b}
    .topbar{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin-bottom:.6rem}
    .btn{background:#fff;color:var(--primary);border:1.6px solid var(--primary);padding:.45rem .7rem;border-radius:8px;font-weight:800;cursor:pointer}
    .btn:hover{background:var(--primary);color:#fff}
    .btn.primary{background:var(--primary);color:#fff;border:none}
    .btn.danger{background:var(--red);color:#fff;border:none}
    .searchbar{display:flex;justify-content:center;margin:.4rem 0 .8rem}
    .searchbar input{width:min(900px,92%);padding:.55rem .7rem;border:1.6px solid var(--primary);border-radius:8px;font-weight:700}

    /* Group headers */
    .region{margin:1rem auto;max-width:1200px}
    .region h2{
      margin:.8rem 0 .4rem;font-size:1.3rem;border-left:6px solid var(--primary);
      padding-left:.5rem;display:flex;align-items:center;gap:.5rem
    }
    .country-h{
      margin:.4rem 0 .3rem;font-size:1.05rem;color:#223;
      display:flex;align-items:center;gap:.5rem;font-weight:800
    }
    .pill{background:#e9f3ff;color:#1a5ea0;border:1px solid #bcd7ff;border-radius:999px;padding:.08rem .5rem;font-size:.8rem;font-weight:800}

    /* Table */
    .table{width:100%;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#fff}
    table{width:100%;border-collapse:collapse;table-layout:fixed}
    th,td{padding:.55rem .6rem;border-bottom:1px solid #f0f0f0;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;font-size:.92rem}
    th{background:#f3f4f6;color:#333;text-align:left}
    tr:hover{background:var(--row)}
    td.center{text-align:center}
    .thumb{width:58px;height:44px;object-fit:cover;border-radius:6px;border:1px solid #eee}
    .type-badges{display:flex;gap:.3rem;flex-wrap:wrap}
    .chip{border:1px solid #cfe1ff;border-radius:999px;padding:.1rem .45rem;font-size:.8rem;color:#1a5ea0;background:#eef6ff}
    .row-actions{display:flex;gap:.4rem;justify-content:flex-end}

    /* Expand row */
    tr.expand td{background:#fbfdff}
    .exp-wrap{padding:.8rem .4rem}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    .grid .full{grid-column:1/-1}
    .field{display:flex;flex-direction:column;gap:.25rem}
    .field input,.field select{padding:.5rem;border:1px solid #ccc;border-radius:8px}
    .chips{display:flex;gap:.35rem;flex-wrap:wrap}
    .chip-toggle{padding:.25rem .6rem;border-radius:999px;border:1px solid #bbb;cursor:pointer}
    .chip-toggle.active{background:#2f78c4;color:#fff;border-color:#2f78c4}
    .muted{color:var(--muted);font-size:.85rem}
    .exp-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.4rem}
    .access-row{display:flex;gap:1rem;align-items:center;flex-wrap:wrap}
    .hide{display:none}

    /* Toast */
    #toast{position:fixed;right:1rem;bottom:1rem;display:flex;flex-direction:column;gap:.45rem;z-index:9999}
    .toast{background:#333;color:#fff;padding:.65rem .9rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2)}
    .toast.ok{background:#1d8348}.toast.err{background:#c0392b}.toast.info{background:#2f78c4}
  </style>
</head>
<body>
  <h1>Approved ‚Äî Backoffice</h1>

  <div class="topbar">
    <button class="btn" onclick="location.href='backoffice.html'">‚Üê Tillbaka till Home</button>
    <button class="btn" onclick="location.reload()">‚Üª Ladda om</button>
  </div>

  <div class="searchbar">
    <input id="q" placeholder="S√∂k (namn, land, state, stad) ‚Ä¶" />
  </div>

  <div id="wrap"></div>
  <div id="toast"></div>

<script>
/* -------- Supabase -------- */
const supabase = window.supabase.createClient(
  "https://gbxxoeplkzbhsvagnfsr.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4"
);

/* -------- Konfig -------- */
const GOOGLE_BROWSER_KEY = "AIzaSyDdn7E6_dfwUjGQ1IUdJ2rQXUeEYIIzVtQ";

/* V√§rldsdelkarta */
const REGION_MAP = {
  "Sweden":"Europa","Norway":"Europa","Denmark":"Europa","Finland":"Europa","Iceland":"Europa",
  "United Kingdom":"Europa","Ireland":"Europa","Germany":"Europa","France":"Europa","Spain":"Europa","Italy":"Europa",
  "Netherlands":"Europa","Belgium":"Europa","Portugal":"Europa","Austria":"Europa","Switzerland":"Europa","Poland":"Europa",
  "Czechia":"Europa","Czech Republic":"Europa","Hungary":"Europa","Greece":"Europa","Turkey":"Europa",
  "USA":"Nordamerika","United States":"Nordamerika","Canada":"Nordamerika","Mexico":"Nordamerika",
  "Brazil":"Sydamerika","Argentina":"Sydamerika","Chile":"Sydamerika","Colombia":"Sydamerika","Peru":"Sydamerika",
  "Australia":"Oceanien","New Zealand":"Oceanien",
  "South Africa":"Afrika","Morocco":"Afrika","Egypt":"Afrika","Kenya":"Afrika","Nigeria":"Afrika",
  "Thailand":"Asien","Malaysia":"Asien","Japan":"Asien","China":"Asien","India":"Asien","Singapore":"Asien","UAE":"Asien","United Arab Emirates":"Asien","Indonesia":"Asien","Philippines":"Asien","Vietnam":"Asien","Hong Kong":"Asien","Taiwan":"Asien","South Korea":"Asien","Saudi Arabia":"Asien","Qatar":"Asien"
};

/* -------- State -------- */
const wrap = document.getElementById('wrap');
const q = document.getElementById('q');
let allApproved = [];
let filtered = [];

/* Bildhj√§lpare */
function photoFrom(store){
  if (store.photo_url && store.photo_url.startsWith("http")) return store.photo_url;
  if (store.photo_reference && !store.photo_reference.startsWith("http")){
    return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=600&photo_reference=${encodeURIComponent(store.photo_reference)}&key=${GOOGLE_BROWSER_KEY}`;
  }
  if (Array.isArray(store.types) && store.types.includes("lounge")) return "images/lounge.jpg";
  if ((store.type||"").toLowerCase()==="lounge") return "images/lounge.jpg";
  if (Array.isArray(store.types) && store.types.includes("store")) return "images/store.jpg";
  return "images/other.jpg";
}

/* Toast */
function toast(msg,type='info'){
  const c=document.getElementById('toast');
  const t=document.createElement('div');
  t.className=`toast ${type==='ok'?'ok':type==='err'?'err':'info'}`;
  t.textContent=msg;
  c.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

/* Region/land helpers */
function regionOf(country){
  return REGION_MAP[country?.trim()] || "√ñvriga";
}
function normalizeTypes(s){
  if (Array.isArray(s.types)) return s.types;
  if (s.type) return [String(s.type).toLowerCase()];
  return [];
}
function typePills(types){
  return types.map(t=>`<span class="chip">${t}</span>`).join(" ");
}

/* S√∂kning */
q.addEventListener('input', ()=>{
  const val = q.value.trim().toLowerCase();
  if (!val){ filtered = [...allApproved]; render(); return; }
  filtered = allApproved.filter(s=>{
    return (s.name||"").toLowerCase().includes(val)
        || (s.country||"").toLowerCase().includes(val)
        || (s.city||"").toLowerCase().includes(val)
        || (s.state||"").toLowerCase().includes(val);
  });
  render();
});

/* Ladda data */
(async function load(){
  const { data, error } = await supabase
    .from('stores')
    .select('*')
    .eq('approved', true)
    .order('name', { ascending:true });

  if (error){
    console.error(error);
    toast("Fel vid laddning (API-nyckel?)","err");
    wrap.innerHTML = `<p style="color:#c0392b;text-align:center">Kunde inte ladda approved.</p>`;
    return;
  }

  allApproved = (data||[]).map(s=>({
    ...s,
    types: normalizeTypes(s),
    country: s.country || "",
    state: (s.state || s.admin_area || s.region || ""), // mjuk fallback
    region: regionOf(s.country||"")
  }));
  filtered = [...allApproved];
  render();
})();

/* Render */
function render(){
  // Gruppera: region ‚Üí land
  const byRegion = new Map();
  for (const s of filtered){
    if (!byRegion.has(s.region)) byRegion.set(s.region, new Map());
    const byCountry = byRegion.get(s.region);
    const key = s.country || "Unknown";
    if (!byCountry.has(key)) byCountry.set(key, []);
    byCountry.get(key).push(s);
  }

  // Sortera regioner alfabetiskt, l√§nder inom region alfabetiskt
  const regions = Array.from(byRegion.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
  let html = "";

  for (const [regionName, countries] of regions){
    // totals
    const regionCount = Array.from(countries.values()).reduce((acc,arr)=>acc+arr.length,0);

    html += `<section class="region">
      <h2>${regionName} <span class="pill">${regionCount}</span></h2>`;

    const sortedCountries = Array.from(countries.entries()).sort((a,b)=>a[0].localeCompare(b[0]));

    for (const [countryName, rows] of sortedCountries){
      html += `<div class="country-h">üá∫üá≥ ${countryName} <span class="pill">${rows.length}</span></div>
      <div class="table">
        <table>
          <thead>
            <tr>
              <th style="width:70px">Bild</th>
              <th style="width:22%">Namn</th>
              <th style="width:12%">Land</th>
              <th style="width:12%">State</th>
              <th style="width:16%">Stad</th>
              <th style="width:24%">Adress</th>
              <th style="width:13%">Telefon</th>
              <th style="width:10%">Typ</th>
              <th style="width:14%">√Ötg√§rder</th>
            </tr>
          </thead>
          <tbody>`;

      for (const s of rows){
        const img = photoFrom(s);
        const types = normalizeTypes(s);
        const typeTxt = types.join(', ') || (s.type||"");
        const showState = (s.country==="USA" || s.country==="United States");
        html += `
          <tr data-id="${s.id}">
            <td><img class="thumb" src="${img}" alt="" onerror="this.onerror=null;this.src='images/store.jpg'"></td>
            <td title="${esc(s.name||'')}">${esc(s.name||"")}</td>
            <td>${esc(s.country||"")}</td>
            <td>${showState ? esc(s.state||"") : ""}</td>
            <td>${esc(s.city||"")}</td>
            <td title="${esc(s.address||'')}">${esc(s.address||"")}</td>
            <td>${esc(s.phone||"")}</td>
            <td><div class="type-badges">${typePills(types)}</div></td>
            <td class="row-actions">
              <button class="btn" onclick="toggleExpand('${s.id}')">Visa / Redigera</button>
            </td>
          </tr>
          <tr id="exp-${s.id}" class="expand hide"><td colspan="9">
            ${expandEditor(s)}
          </td></tr>`;
      }

      html += `</tbody></table></div>`;
    }

    html += `</section>`;
  }

  wrap.innerHTML = html;
}

/* Expand editor markup */
function expandEditor(s){
  const types = normalizeTypes(s);
  const isLounge = types.includes('lounge');

  return `
    <div class="exp-wrap">
      <div class="grid">
        <div class="field">
          <label>Namn</label>
          <input id="nm-${s.id}" value="${esc(s.name||"")}" />
        </div>
        <div class="field">
          <label>Telefon</label>
          <input id="ph-${s.id}" value="${esc(s.phone||"")}" />
        </div>

        <div class="field full">
          <label>Adress</label>
          <input id="ad-${s.id}" value="${esc(s.address||"")}" />
        </div>

        <div class="field">
          <label>Stad</label>
          <input id="ct-${s.id}" value="${esc(s.city||"")}" />
        </div>
        <div class="field">
          <label>Land</label>
          <input id="co-${s.id}" value="${esc(s.country||"")}" />
        </div>

        <div class="field">
          <label>State (USA)</label>
          <input id="st-${s.id}" value="${esc(s.state||"")}" placeholder="t.ex. New York" />
        </div>
        <div class="field">
          <label>Webbplats</label>
          <input id="wb-${s.id}" value="${esc(s.website||"")}" />
        </div>

        <div class="field full">
          <label>Typer</label>
          <div class="chips" id="tp-${s.id}">
            ${chipToggle('store', types.includes('store'))}
            ${chipToggle('lounge', types.includes('lounge'))}
            ${chipToggle('other', types.includes('other'))}
          </div>
          <div class="muted">V√§lj en eller flera.</div>
        </div>

        <div class="field full ${isLounge?'':'hide'}" id="accwrap-${s.id}">
          <label>Lounge access</label>
          <div class="access-row" id="ac-${s.id}">
            ${radio('public','√ñppen f√∂r alla', s.access==='public')}
            ${radio('temporary','Tillf√§lliga medlemmar', s.access==='temporary')}
            ${radio('members','Endast medlemmar', s.access==='members')}
          </div>
        </div>

        <div class="field">
          <label>Foto-URL</label>
          <input id="pu-${s.id}" value="${esc(s.photo_url||"")}" placeholder="(valfri) Direktl√§nk till bild" />
        </div>
        <div class="field">
          <label>Photo reference</label>
          <input id="pr-${s.id}" value="${esc(s.photo_reference||"")}" placeholder="(valfri) Google photo_reference" />
        </div>

        <div class="field full muted">
          place_id: ${esc(s.place_id||"-")}
        </div>

        <div class="field full exp-actions">
          <button class="btn" onclick="toggleExpand('${s.id}')">Avbryt</button>
          <button class="btn primary" onclick="saveRow('${s.id}')">Spara</button>
        </div>
      </div>
    </div>
  `;
}

function chipToggle(val, active){
  return `<span class="chip-toggle ${active?'active':''}" data-v="${val}" onclick="toggleType(this)">${val}</span>`;
}
function radio(value,label,checked){
  return `<label><input type="radio" name="acc-${Math.random().toString(36).slice(2)}" data-v="${value}" ${checked?'checked':''} onclick="setAccess(this)"/> ${label}</label>`;
}

/* Expand toggle */
function toggleExpand(id){
  const row = document.getElementById(`exp-${id}`);
  if (!row) return;
  row.classList.toggle('hide');

  // s√§kerst√§ll lounge access-sektionen f√∂ljer typer
  syncAccessVisibility(id);
}

/* Typ & access styrning */
function toggleType(el){
  el.classList.toggle('active');
  const rowId = el.closest('.chips').id.split('tp-')[1];
  syncAccessVisibility(rowId);
}
function syncAccessVisibility(id){
  const chips = Array.from(document.querySelectorAll(`#tp-${id} .chip-toggle.active`)).map(x=>x.dataset.v);
  const hasLounge = chips.includes('lounge');
  const box = document.getElementById(`accwrap-${id}`);
  if (box) box.classList.toggle('hide', !hasLounge);
}
function setAccess(radioEl){
  // handled on save by reading checked input in container
}

/* Spara rad */
async function saveRow(id){
  try{
    const name = gval(`nm-${id}`);
    const phone = gval(`ph-${id}`);
    const address = gval(`ad-${id}`);
    const city = gval(`ct-${id}`);
    const country = gval(`co-${id}`);
    const state = gval(`st-${id}`);
    const website = gval(`wb-${id}`);
    const photo_url = gval(`pu-${id}`) || null;
    const photo_reference = gval(`pr-${id}`) || null;

    const types = Array.from(document.querySelectorAll(`#tp-${id} .chip-toggle.active`)).map(x=>x.dataset.v);
    // access om lounge vald
    let access = null;
    if (types.includes('lounge')){
      const acWrap = document.getElementById(`accwrap-${id}`);
      const chosen = acWrap ? acWrap.querySelector('input[type="radio"]:checked') : null;
      access = chosen ? chosen.getAttribute('data-v') : null;
    }

    const payload = {
      name, phone, address, city, country, state, website,
      types, type: types[0] || null,
      access,
      photo_url, photo_reference
    };

    const { error } = await supabase.from('stores').update(payload).eq('id', id);
    if (error) throw error;

    toast("Sparat!","ok");
    // uppdatera lokalt och rendera om snabbt
    const idx = allApproved.findIndex(x=>x.id===id);
    if (idx>-1){
      allApproved[idx] = { ...allApproved[idx], ...payload };
      allApproved[idx].region = regionOf(allApproved[idx].country||"");
    }
    // √•terskapa filtered utifr√•n s√∂k
    const val = q.value.trim().toLowerCase();
    filtered = val ? allApproved.filter(s =>
      (s.name||"").toLowerCase().includes(val)
      || (s.country||"").toLowerCase().includes(val)
      || (s.city||"").toLowerCase().includes(val)
      || (s.state||"").toLowerCase().includes(val)
    ) : [...allApproved];

    render();
  }catch(err){
    console.error(err);
    toast("Kunde inte spara","err");
  }
}

/* Utils */
function gval(id){ return (document.getElementById(id)?.value || "").trim(); }
function esc(s){ return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

</script>
</body>
</html>
