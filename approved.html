<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Approved Locations — Backoffice</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
  <style>
    :root {
      --primary:#2f78c4; --primary-dark:#2466a8;
      --accent:#28a745; --bg:#f5f6f8; --card:#fff;
      --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);padding:1.2rem;color:var(--text)}
    h1{text-align:center;font-size:1.5rem;margin-bottom:1rem}
    .topbar{display:flex;justify-content:center;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}
    .btn{background:#fff;border:1.6px solid var(--primary);color:var(--primary);
         padding:.5rem .8rem;border-radius:8px;font-weight:800;cursor:pointer}
    .btn:hover{background:var(--primary);color:#fff}

    /* --- Search Autocomplete --- */
    .autocomplete-wrapper{position:relative;max-width:400px;margin:0 auto 1rem}
    #searchInput{width:100%;padding:.6rem;border:1.4px solid var(--primary);border-radius:8px;font-size:.95rem}
    .autocomplete-list{
      position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ccc;
      border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);
      z-index:1000;max-height:180px;overflow-y:auto;
    }
    .autocomplete-list div{padding:.5rem .7rem;cursor:pointer;border-bottom:1px solid #eee}
    .autocomplete-list div:hover{background:#f2f6fc;}

    /* --- Grouping --- */
    h2.section{margin-top:1.4rem;font-size:1.2rem;color:var(--primary-dark);border-bottom:2px solid var(--primary);padding-bottom:.2rem}
    h3.subsection{margin:.8rem 0 .4rem;font-size:1rem;color:var(--accent)}

    /* --- Cards --- */
    .card{
      background:var(--card);border:1px solid var(--border);border-radius:10px;
      padding:.7rem;margin-bottom:.6rem;box-shadow:0 1px 3px rgba(0,0,0,.05);
      transition:all .25s ease-in-out;cursor:pointer;
    }
    .card:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .card.expanded{background:#eef6ff;border-color:#bcd7ff;}
    .card-header{display:flex;align-items:center;gap:.7rem}
    .card-header img{width:60px;height:60px;object-fit:cover;border-radius:6px}
    .card-header h4{font-size:1rem;margin:0;flex:1}

    .details{display:none;margin-top:.6rem;font-size:.9rem;color:#333}
    .card.expanded .details{display:block}
    .details a{color:var(--primary);text-decoration:none;font-weight:600}
    .details a:hover{text-decoration:underline}

    .actions{margin-top:.6rem;display:flex;gap:.4rem;flex-wrap:wrap}
    .btn.small{font-size:.8rem;padding:.3rem .6rem}
    .btn.danger{border:none;background:#c0392b;color:#fff}
    .btn.edit{border:none;background:#b8860b;color:#fff}
    .btn.flag{border:none;background:#b36e00;color:#fff}

    #toast-container{position:fixed;bottom:1rem;right:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:9999}
    .toast{background:#333;color:#fff;padding:.7rem 1rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2);opacity:.97}
    .toast.success{background:#28a745}.toast.error{background:#dc3545}.toast.info{background:#2f78c4}
  </style>
</head>
<body>
  <div class="topbar">
    <button class="btn" onclick="window.location.href='backoffice.html'">← Tillbaka till Home</button>
  </div>
  <h1>Approved Locations</h1>

  <div class="autocomplete-wrapper">
    <input id="searchInput" type="text" placeholder="Sök efter namn, stad eller land...">
    <div id="autocomplete-list" class="autocomplete-list"></div>
  </div>

  <div id="content"></div>
  <div id="toast-container"></div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  const supabase = createClient(
    "https://gbxxoeplkzbhsvagnfsr.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4"
  );

  const content = document.getElementById("content");
  const searchInput = document.getElementById("searchInput");
  const listEl = document.getElementById("autocomplete-list");
  let allStores = [];

  await loadData();
  renderAll();

  async function loadData(){
    const { data, error } = await supabase.from("stores").select("*").eq("approved", true).neq("status","deleted");
    if(error){ console.error(error); showToast("Kunde inte hämta data","error"); return; }
    allStores = data;
  }

  function groupBy(arr, keyFn){
    return arr.reduce((acc,item)=>{
      const key = keyFn(item) || "Övrigt";
      if(!acc[key]) acc[key]=[];
      acc[key].push(item);
      return acc;
    },{});
  }

  function renderAll(){
    const byCountry = groupBy(allStores, s => s.country);
    content.innerHTML = "";

    for(const [country, list] of Object.entries(byCountry).sort()){
      const h2 = document.createElement("h2");
      h2.textContent = country;
      h2.className = "section";
      content.appendChild(h2);

      const byCity = groupBy(list, s => s.city);
      for(const [city, items] of Object.entries(byCity).sort()){
        const h3 = document.createElement("h3");
        h3.textContent = city;
        h3.className = "subsection";
        content.appendChild(h3);

        for(const s of items.sort((a,b)=>a.name.localeCompare(b.name))){
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.id = s.id;
          card.innerHTML = `
            <div class="card-header">
              <img src="${s.photo_url || 'images/store.jpg'}" onerror="this.src='images/store.jpg'"/>
              <h4>${s.name}</h4>
            </div>
            <div class="details">
              <div><b>Adress:</b> ${s.address || '–'}</div>
              <div><b>Telefon:</b> ${s.phone || '–'}</div>
              <div><b>Website:</b> ${s.website ? `<a href="${s.website}" target="_blank">${s.website}</a>` : '–'}</div>
              <div><b>Typ:</b> ${s.type || '–'} ${s.access ? `(${s.access})` : ''}</div>
              <div><b>Rating:</b> ${s.rating || '–'}</div>
              <div class="actions">
                <button class="btn small edit" onclick="editStore('${s.id}')">Edit</button>
                <button class="btn small flag" onclick="flagStore('${s.id}')">Flag</button>
                <button class="btn small danger" onclick="deleteStore('${s.id}')">Delete</button>
              </div>
            </div>
          `;
          card.addEventListener("click",e=>{
            if(e.target.closest("button")) return;
            card.classList.toggle("expanded");
          });
          content.appendChild(card);
        }
      }
    }
  }

  /* --- Autocomplete Search --- */
  searchInput.addEventListener("input",()=>{
    const q = searchInput.value.toLowerCase();
    listEl.innerHTML = "";
    if(q.length < 2) return;
    const matches = allStores.filter(s =>
      (s.name && s.name.toLowerCase().includes(q)) ||
      (s.city && s.city.toLowerCase().includes(q)) ||
      (s.country && s.country.toLowerCase().includes(q))
    ).slice(0,10);

    matches.forEach(m=>{
      const div = document.createElement("div");
      div.textContent = `${m.name} (${m.city}, ${m.country})`;
      div.addEventListener("click",()=>{
        searchInput.value = m.name;
        listEl.innerHTML = "";
        highlightStore(m.id);
      });
      listEl.appendChild(div);
    });
  });

  function highlightStore(id){
    const el = document.querySelector(`.card[data-id='${id}']`);
    if(el){
      el.scrollIntoView({behavior:"smooth", block:"center"});
      el.classList.add("expanded");
      showToast("Visar: "+el.querySelector("h4").textContent,"info");
    } else showToast("Hittades inte","error");
  }

  /* --- Actions --- */
  window.editStore = async (id)=>{
    window.location.href = `add-store-backoffice.html?edit=${id}`;
  }
  window.flagStore = async (id)=>{
    await supabase.from("stores").update({flagged:true}).eq("id",id);
    showToast("Flaggad","info");
  }
  window.deleteStore = async (id)=>{
    const ok = confirm("Vill du verkligen ta bort?");
    if(!ok) return;
    await supabase.from("stores").update({status:"deleted"}).eq("id",id);
    showToast("Borttagen","error");
  }

  function showToast(msg,type="info"){
    const c=document.getElementById("toast-container");
    const t=document.createElement("div");
    t.className=`toast ${type}`;
    t.textContent=msg;
    c.appendChild(t);
    setTimeout(()=>t.remove(),3000);
  }
</script>
</body>
</html>
