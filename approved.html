<!-- approved.html — Backoffice Approved (hierarki + global sök + inline edit + pagination) v2 -->
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Backoffice — Approved</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --primary:#2f78c4; --primary-dark:#2466a8;
      --bg:#f5f6f8; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
      --pill:#e8f1fb; --pilltext:#1a5fa5; --danger:#c0392b; --success:#1d8348; --warning:#b36e00;
    }
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:1rem;color:var(--text);font-size:14px}
    h1{margin:.2rem 0 1rem;text-align:center;color:#2b2b2b}
    .topbar{display:flex;justify-content:center;gap:.5rem;flex-wrap:wrap;margin-bottom:1rem}
    .btn{background:#fff;border:1.6px solid var(--primary);color:var(--primary);padding:.45rem .8rem;border-radius:8px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border:none}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn:hover{filter:brightness(.96)}
    .wrap{max-width:1100px;margin:0 auto}
    .searchbar{display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap;margin-bottom:1rem}
    .input{border:1.6px solid var(--primary);border-radius:8px;padding:.45rem .7rem;min-width:260px}
    .muted{color:var(--muted)}
    .section{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.06);margin-bottom:.6rem}
    .section-header{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem;cursor:pointer;user-select:none}
    .section-header:hover{background:#f8fbff}
    .chev{font-weight:900;color:var(--primary-dark)}
    .pill{background:var(--pill);color:var(--pilltext);padding:.15rem .5rem;border-radius:999px;font-weight:800;font-size:.8rem}
    .section-body{padding:.3rem .8rem .8rem;display:none}
    .section-body.open{display:block}
    .row{display:flex;justify-content:space-between;align-items:center;padding:.45rem .6rem;border:1px solid var(--border);border-radius:8px;margin:.35rem 0;background:#fff;cursor:pointer}
    .row:hover{background:#f9fbff}
    .row-title{display:flex;align-items:center;gap:.5rem}
    .indent-1{margin-left:1.25rem}
    .indent-2{margin-left:2.0rem}
    .indent-3{margin-left:2.75rem}

    table{width:100%;border-collapse:collapse;margin-top:.5rem}
    th,td{border-bottom:1px solid #eee;padding:.5rem .4rem;text-align:left}
    th{background:#f3f4f6;font-weight:800}
    td.num{text-align:center}
    .actions{display:flex;gap:.35rem;flex-wrap:wrap}
    .tag{display:inline-block;padding:.18rem .5rem;border-radius:999px;background:#eef2f7;color:#334155;font-size:.78rem;font-weight:700}
    .row-edit{background:#fcfdfd}
    .edit-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .edit-grid .full{grid-column:1/-1}
    input[type="text"],input[type="url"],input[type="tel"]{width:100%;padding:.5rem;border:1px solid #ccc;border-radius:8px}
    .chips{display:flex;gap:.4rem;flex-wrap:wrap}
    .chip{border:1px solid var(--border);padding:.25rem .6rem;border-radius:14px;cursor:pointer}
    .chip.active{background:#eef6ff;border-color:#bcd7ff;color:#145b99}
    .paging{display:flex;gap:.35rem;align-items:center;justify-content:flex-end;margin-top:.4rem}
    .paging button{padding:.28rem .5rem;border:1px solid var(--primary);background:#fff;color:var(--primary);border-radius:6px;font-weight:800;cursor:pointer}
    .paging .muted{font-size:.86rem}
    #toast-container{position:fixed;bottom:1rem;right:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:9999}
    .toast{background:#333;color:#fff;padding:.7rem 1rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.2);opacity:.97}
    .toast.success{background:#28a745}.toast.error{background:#dc3545}.toast.info{background:#2f78c4}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <button class="btn" onclick="window.location.href='backoffice.html'">← Tillbaka till Home</button>
      <button class="btn" onclick="window.location.href='add-store-backoffice.html'">+ Lägg till Store</button>
    </div>

    <h1>Godkända platser (Approved)</h1>

    <div class="searchbar">
      <input id="search" class="input" type="text" placeholder="Sök i alla platser: namn / stad / land / state / website…"/>
      <button class="btn" onclick="doSearch()">Sök</button>
      <button class="btn" onclick="clearSearch()">Rensa</button>
      <span class="muted" id="searchMeta"></span>
    </div>

    <!-- Hierarki-render här -->
    <div id="hierarchy"></div>
  </div>

  <div id="toast-container"></div>

  <script>
    /* ---------- Supabase ---------- */
    const SUPABASE_URL = "https://gbxxoeplkzbhsvagnfsr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ---------- State ---------- */
    let all = [];            // alla approved (ej deleted)
    let searchQ = "";
    const PAGE_SIZE = 50;

    /* ---------- Helpers ---------- */
    // Continenter ska visas på engelska
    const CONTINENTS = {
      EUROPE: "Europe",
      NORTH_AMERICA: "North America",
      SOUTH_AMERICA: "South America",
      ASIA: "Asia",
      AFRICA: "Africa",
      OCEANIA: "Oceania",
      OTHER: "Other"
    };

    const northAmericaCountries = new Set(["united states","usa","canada","mexico"]);

    const continentMap = (()=> {
      // Lowercase country keys → English continent names
      const EU = ["sweden","norway","denmark","finland","iceland","germany","france","spain","italy","portugal","netherlands","belgium","luxembourg","ireland","austria","poland","czech republic","czechia","hungary","slovakia","slovenia","croatia","estonia","latvia","lithuania","romania","bulgaria","greece","malta","cyprus","switzerland","united kingdom","england","scotland","wales","northern ireland","serbia","bosnia","albania","kosovo","north macedonia","montenegro","moldova","ukraine","belarus","andorra","monaco","liechtenstein","san marino","vatican city"];
      const NA = ["united states","usa","canada","mexico"];
      const SA = ["brazil","argentina","chile","peru","colombia","uruguay","paraguay","bolivia","ecuador","venezuela","guyana","suriname"];
      const AS = ["japan","china","taiwan","south korea","korea","thailand","vietnam","laos","cambodia","myanmar","singapore","malaysia","indonesia","philippines","india","pakistan","sri lanka","maldives","nepal","bangladesh","mongolia","kazakhstan","uzbekistan","kyrgyzstan","tajikistan","turkmenistan","saudi arabia","uae","united arab emirates","qatar","bahrain","kuwait","oman","iran","iraq","israel","jordan","lebanon","turkey","georgia","armenia","azerbaijan"];
      const AF = ["south africa","egypt","morocco","algeria","tunisia","libya","kenya","tanzania","ethiopia","nigeria","ghana","ivory coast","côte d’ivoire","cote d'ivoire","senegal","uganda","rwanda","botswana","namibia","zimbabwe","zambia","angola","cameroon","democratic republic of the congo"];
      const OC = ["australia","new zealand","fiji","papua new guinea","samoa","tonga"];
      const map = new Map();
      EU.forEach(c=>map.set(c, CONTINENTS.EUROPE));
      NA.forEach(c=>map.set(c, CONTINENTS.NORTH_AMERICA));
      SA.forEach(c=>map.set(c, CONTINENTS.SOUTH_AMERICA));
      AS.forEach(c=>map.set(c, CONTINENTS.ASIA));
      AF.forEach(c=>map.set(c, CONTINENTS.AFRICA));
      OC.forEach(c=>map.set(c, CONTINENTS.OCEANIA));
      return map;
    })();

    function getContinent(country){
      const key = String(country||"").trim().toLowerCase();
      return continentMap.get(key) || CONTINENTS.OTHER;
    }

    function showToast(msg,type="info"){
      const c=document.getElementById("toast-container");
      const t=document.createElement("div");
      t.className=`toast ${type}`; t.textContent=msg;
      c.appendChild(t);
      setTimeout(()=>t.remove(),3200);
    }

    function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c])); }

    /* ---------- Load ---------- */
    (async function init(){
      const { data, error } = await supabase
        .from("stores")
        .select("*")
        .eq("approved", true)
        .eq("deleted", false)
        .order("country", {ascending:true})
        .order("state", {ascending:true})
        .order("city", {ascending:true})
        .order("name", {ascending:true});

      if (error) { showToast(error.message,"error"); return; }

      // normalisera typer och säkerställ state
      all = (data||[]).map(s => ({
        ...s,
        types: Array.isArray(s.types) ? s.types : (s.type ? [s.type] : []),
        state: s.state || s.region || s.admin_area || null,
      }));

      renderHierarchy();
    })();

    /* ---------- Search ---------- */
    function doSearch(){
      searchQ = document.getElementById("search").value.trim();
      renderHierarchy();
    }
    function clearSearch(){
      document.getElementById("search").value = "";
      searchQ = "";
      renderHierarchy();
    }

    function matchesSearch(s){
      if (!searchQ) return true;
      const q = searchQ.toLowerCase();
      return [
        s.name, s.city, s.country, s.state, s.address, s.website
      ].some(v => (v||"").toLowerCase().includes(q));
    }

    /* ---------- Group & Render ---------- */
    function groupData(rows){
      // om global sök → filtrera först
      const src = searchQ ? rows.filter(matchesSearch) : rows;

      const byContinent = new Map();
      for (const s of src){
        const cont = getContinent(s.country);
        if (!byContinent.has(cont)) byContinent.set(cont, new Map());
        const byCountry = byContinent.get(cont);
        const cc = (s.country||"Unknown").trim();
        if (!byCountry.has(cc)) byCountry.set(cc, []);
        byCountry.get(cc).push(s);
      }
      // sortera länder alfabetiskt inom kontinent
      for (const [cont, cmap] of byContinent){
        const sorted = new Map([...cmap.entries()].sort((a,b)=>a[0].localeCompare(b[0])));
        byContinent.set(cont, sorted);
      }
      return byContinent;
    }

    function renderHierarchy(){
      const root = document.getElementById("hierarchy");
      root.innerHTML = "";

      const grouped = groupData(all);

      // visa sökmeta
      const totalShown = searchQ ? [...grouped.values()].reduce((acc, cmap)=>acc + [...cmap.values()].reduce((x,arr)=>x+arr.length,0),0) : all.length;
      const meta = document.getElementById("searchMeta");
      meta.textContent = searchQ ? `Visar ${totalShown} matchningar` : `Totalt ${all.length} godkända`;

      for (const [continent, countries] of grouped){
        const sec = document.createElement("div");
        sec.className = "section";

        const contCount = [...countries.values()].reduce((acc, arr)=>acc+arr.length,0);
        sec.innerHTML = `
          <div class="section-header" onclick="this.nextElementSibling.classList.toggle('open')">
            <div class="chev">▸</div>
            <div style="font-weight:900">${esc(continent)}</div>
            <span class="pill">${contCount}</span>
          </div>
          <div class="section-body"></div>
        `;
        root.appendChild(sec);

        const body = sec.querySelector(".section-body");
        for (const [countryName, rows] of countries){
          // land-rad
          const cDiv = document.createElement("div");
          cDiv.className = "row";
          const count = rows.length;
          cDiv.innerHTML = `
            <div class="row-title">
              <div class="chev">▸</div>
              <div style="font-weight:800">${esc(countryName)}</div>
              <span class="pill">${count}</span>
            </div>
            <div class="muted">${esc(continent)}</div>
          `;
          body.appendChild(cDiv);

          // container för nästa nivå (state/city) — göms tills klick
          const levelWrap = document.createElement("div");
          levelWrap.style.display = "none";
          body.appendChild(levelWrap);

          cDiv.addEventListener("click", ()=>{
            const open = levelWrap.style.display === "block";
            levelWrap.style.display = open ? "none" : "block";
            if (!open) renderCountryLevel(rows, levelWrap, countryName);
          });
        }
      }
    }

    function renderCountryLevel(rows, wrap, countryName){
      wrap.innerHTML = "";

      const isNA = northAmericaCountries.has(String(countryName).toLowerCase());
      if (isNA){
        // Group: State -> City -> Stores
        const byState = new Map();
        for (const s of rows){
          const st = (s.state||"Unknown").trim();
          if (!byState.has(st)) byState.set(st, new Map());
          const byCity = byState.get(st);
          const city = (s.city||"Unknown").trim();
          if (!byCity.has(city)) byCity.set(city, []);
          byCity.get(city).push(s);
        }
        // Sort states alphabetically
        const sortedStates = [...byState.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
        for (const [stateName, cityMap] of sortedStates){
          const stateCount = [...cityMap.values()].reduce((acc,arr)=>acc+arr.length,0);
          const sRow = document.createElement("div");
          sRow.className = "row indent-1";
          sRow.innerHTML = `
            <div class="row-title">
              <div class="chev">▸</div>
              <div style="font-weight:800">${esc(stateName)}</div>
              <span class="pill">${stateCount}</span>
            </div>
            <div class="muted">${esc(countryName)}</div>
          `;
          wrap.appendChild(sRow);

          const cityWrap = document.createElement("div");
          cityWrap.style.display = "none";
          wrap.appendChild(cityWrap);

          sRow.addEventListener("click", ()=>{
            const open = cityWrap.style.display === "block";
            cityWrap.style.display = open ? "none" : "block";
            if (!open) renderCityLevel(cityMap, cityWrap, countryName, stateName);
          });
        }
      } else {
        // Group: City -> Stores
        const byCity = new Map();
        for (const s of rows){
          const city = (s.city||"Unknown").trim();
          if (!byCity.has(city)) byCity.set(city, []);
          byCity.get(city).push(s);
        }
        const sortedCities = [...byCity.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
        for (const [cityName, stores] of sortedCities){
          const ctRow = document.createElement("div");
          ctRow.className = "row indent-1";
          ctRow.innerHTML = `
            <div class="row-title">
              <div class="chev">▸</div>
              <div style="font-weight:800">${esc(cityName)}</div>
              <span class="pill">${stores.length}</span>
            </div>
            <div class="muted">${esc(countryName)}</div>
          `;
          wrap.appendChild(ctRow);

          const tableWrap = document.createElement("div");
          tableWrap.style.display = "none";
          wrap.appendChild(tableWrap);

          ctRow.addEventListener("click", ()=>{
            const open = tableWrap.style.display === "block";
            tableWrap.style.display = open ? "none" : "block";
            if (!open) renderStoreTable(stores, tableWrap, countryName, null, cityName);
          });
        }
      }
    }

    function renderCityLevel(cityMap, wrap, countryName, stateName){
      wrap.innerHTML = "";
      const sortedCities = [...cityMap.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
      for (const [cityName, stores] of sortedCities){
        const ctRow = document.createElement("div");
        ctRow.className = "row indent-2";
        ctRow.innerHTML = `
          <div class="row-title">
            <div class="chev">▸</div>
            <div style="font-weight:800">${esc(cityName)}</div>
            <span class="pill">${stores.length}</span>
          </div>
          <div class="muted">${esc(stateName)}</div>
        `;
        wrap.appendChild(ctRow);

        const tableWrap = document.createElement("div");
        tableWrap.style.display = "none";
        wrap.appendChild(tableWrap);

        ctRow.addEventListener("click", ()=>{
          const open = tableWrap.style.display === "block";
          tableWrap.style.display = open ? "none" : "block";
          if (!open) renderStoreTable(stores, tableWrap, countryName, stateName, cityName);
        });
      }
    }

    function renderStoreTable(rows, wrap, countryName, stateName, cityName){
      const totalPages = Math.max(1, Math.ceil(rows.length / PAGE_SIZE));
      const startPage = 1;
      renderStoreTablePage(rows, wrap, startPage, totalPages);
    }

    function renderStoreTablePage(rows, wrap, page=1, totalPages=1){
      const start = (page-1)*PAGE_SIZE;
      const slice = rows.slice(start, start+PAGE_SIZE);

      wrap.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Namn</th>
              <th>Stad</th>
              <th>State</th>
              <th>Land</th>
              <th>Typer</th>
              <th>Website</th>
              <th class="num">Betyg</th>
              <th>Åtgärder</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="paging">
          <button ${page<=1?'disabled':''} data-act="prev">◀</button>
          <span class="muted">Sida ${page}/${totalPages}</span>
          <button ${page>=totalPages?'disabled':''} data-act="next">▶</button>
        </div>
      `;

      const tbody = wrap.querySelector("tbody");
      slice.forEach(s => tbody.appendChild(renderRow(s)));

      // paging händelser
      const prevBtn = wrap.querySelector('button[data-act="prev"]');
      const nextBtn = wrap.querySelector('button[data-act="next"]');
      prevBtn?.addEventListener("click", ()=>{
        if (page>1){ renderStoreTablePage(rows, wrap, page-1, totalPages); }
      });
      nextBtn?.addEventListener("click", ()=>{
        if (page<totalPages){ renderStoreTablePage(rows, wrap, page+1, totalPages); }
      });
    }

    function renderRow(s){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${esc(s.name||"–")}</td>
        <td>${esc(s.city||"–")}</td>
        <td>${esc(s.state||"")}</td>
        <td>${esc(s.country||"–")}</td>
        <td>${esc((s.types&&s.types.length?s.types.join(" & "):(s.type||"–")))}</td>
        <td>${s.website? `<a href="${esc(s.website)}" target="_blank">Öppna</a>` : '—'}</td>
        <td class="num">${s.rating??0}</td>
        <td class="actions">
          <button class="btn" data-act="view">Visa</button>
          <button class="btn" data-act="edit">Redigera</button>
          <button class="btn" data-act="flag">${s.flagged?'Unflag':'Flag'}</button>
          <button class="btn" data-act="unapprove">Unapprove</button>
          <button class="btn" data-act="trash" style="border-color:var(--danger);color:var(--danger)">Trash</button>
        </td>
      `;

      // edit-/view-rad under
      const trEdit = document.createElement("tr");
      trEdit.className="row-edit";
      trEdit.style.display="none";
      const td = document.createElement("td");
      td.colSpan = 8;
      td.innerHTML = renderEditFormHTML(s);
      trEdit.appendChild(td);

      // handlers
      tr.querySelector('[data-act="view"]').addEventListener("click", ()=>{
        trEdit.style.display = trEdit.style.display==="none" ? "table-row" : "none";
        // visa-läge (disable inputs)
        setFormValues(td, s, true);
      });

      tr.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
        trEdit.style.display = "table-row";
        setFormValues(td, s, false);
      });

      tr.querySelector('[data-act="flag"]').addEventListener("click", async ()=>{
        const { error } = await supabase.from("stores").update({ flagged: !s.flagged }).eq("id", s.id);
        if (error) return showToast(error.message,"error");
        s.flagged = !s.flagged;
        showToast(s.flagged?"🚩 Flagged":"🚫 Unflagged","success");
        // uppdatera knapptext
        tr.querySelector('[data-act="flag"]').textContent = s.flagged? "Unflag":"Flag";
      });

      tr.querySelector('[data-act="unapprove"]').addEventListener("click", async ()=>{
        const { error } = await supabase.from("stores")
          .update({ approved:false, status:"pending", approved_at:null })
          .eq("id", s.id);
        if (error) return showToast(error.message,"error");
        showToast("⏳ Flyttad till Pending","success");
        // ta bort raden ur vyn
        tr.remove(); trEdit.remove();
        // ta bort i minnet också
        const idx = all.findIndex(x=>x.id===s.id);
        if (idx>-1) all.splice(idx,1);
      });

      tr.querySelector('[data-act="trash"]').addEventListener("click", async ()=>{
        const deletedUntil = new Date(Date.now()+48*60*60*1000).toISOString();
        const { error } = await supabase.from("stores")
          .update({ deleted:true, deleted_until:deletedUntil })
          .eq("id", s.id);
        if (error) return showToast(error.message,"error");
        showToast("🗑️ Flyttad till Trash (48h)","success");
        tr.remove(); trEdit.remove();
        const idx = all.findIndex(x=>x.id===s.id);
        if (idx>-1) all.splice(idx,1);
      });

      // spara/avbryt inne i edit-raden
      td.querySelector('[data-act="cancel"]').addEventListener("click", ()=>{
        trEdit.style.display="none";
      });
      td.querySelector('[data-act="save"]').addEventListener("click", async ()=>{
        const payload = readFormValues(td, s);
        const { error } = await supabase.from("stores").update(payload).eq("id", s.id);
        if (error) return showToast(error.message,"error");
        Object.assign(s, payload); // uppdatera i minnet
        showToast("✅ Sparat","success");
        // uppdatera primärraden snabbt
        tr.children[0].textContent = s.name || "–";           // Namn
        tr.children[1].textContent = s.city || "–";           // Stad
        tr.children[2].textContent = s.state || "";           // State
        tr.children[3].textContent = s.country || "–";        // Land
        tr.children[4].textContent = (s.types && s.types.length ? s.types.join(" & ") : (s.type||"–"));
        tr.children[5].innerHTML = s.website ? `<a href="${esc(s.website)}" target="_blank">Öppna</a>` : "—";
        tr.children[6].textContent = s.rating ?? 0;
      });

      const frag = document.createDocumentFragment();
      frag.appendChild(tr);
      frag.appendChild(trEdit);
      return frag;
    }

    function renderEditFormHTML(s){
      return `
        <div class="edit-grid">
          <div>
            <label>Namn</label>
            <input type="text" data-f="name" />
          </div>
          <div>
            <label>Telefon</label>
            <input type="tel" data-f="phone" />
          </div>
          <div class="full">
            <label>Adress</label>
            <input type="text" data-f="address" />
          </div>
          <div>
            <label>Stad</label>
            <input type="text" data-f="city" />
          </div>
          <div>
            <label>State (om tillämpligt)</label>
            <input type="text" data-f="state" />
          </div>
          <div>
            <label>Land</label>
            <input type="text" data-f="country" />
          </div>
          <div class="full">
            <label>Webbplats</label>
            <input type="url" data-f="website" />
          </div>

          <div class="full">
            <label>Kategorier (multival)</label>
            <div class="chips" data-f="types">
              ${["store","lounge","other"].map(t=>`<span class="chip" data-v="${t}">${t}</span>`).join("")}
            </div>
            <div class="muted">Klicka för att toggla; minst 1 rekommenderas.</div>
          </div>

          <div class="full">
            <label>Bild-URL (lämna tom för att behålla)</label>
            <input type="url" data-f="photo_url" placeholder="https://…"/>
            <div class="muted">Används på andra vyer; här visas inga bilder.</div>
          </div>

          <div class="full" style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:.4rem">
            <button class="btn" data-act="cancel" type="button">Avbryt</button>
            <button class="btn primary" data-act="save" type="button">Spara</button>
          </div>
        </div>
      `;
    }

    function setFormValues(container, s, viewOnly=false){
      container.querySelector('[data-f="name"]').value    = s.name||"";
      container.querySelector('[data-f="phone"]').value   = s.phone||"";
      container.querySelector('[data-f="address"]').value = s.address||"";
      container.querySelector('[data-f="city"]').value    = s.city||"";
      container.querySelector('[data-f="state"]').value   = s.state||"";
      container.querySelector('[data-f="country"]').value = s.country||"";
      container.querySelector('[data-f="website"]').value = s.website||"";
      container.querySelector('[data-f="photo_url"]').value = s.photo_url||"";

      // typer
      const chips = container.querySelectorAll('[data-f="types"] .chip');
      const set = new Set((s.types && s.types.length ? s.types : (s.type?[s.type]:[])).map(x=>String(x).toLowerCase()));
      chips.forEach(ch=>{
        const v = ch.dataset.v;
        ch.classList.toggle("active", set.has(v));
        ch.onclick = ()=>{
          if (viewOnly) return;
          ch.classList.toggle("active");
        };
      });

      // disable inputs i visa-läge
      container.querySelectorAll("input").forEach(inp => inp.disabled = viewOnly);
      container.querySelector('[data-act="save"]').style.display = viewOnly ? "none" : "inline-block";
    }

    function readFormValues(container, old){
      const get = sel => container.querySelector(sel).value.trim();
      const chips = Array.from(container.querySelectorAll('[data-f="types"] .chip.active')).map(ch=>ch.dataset.v);

      const payload = {
        name: get('[data-f="name"]') || null,
        phone: get('[data-f="phone"]') || null,
        address: get('[data-f="address"]') || null,
        city: get('[data-f="city"]') || null,
        country: get('[data-f="country"]') || null,
        website: get('[data-f="website"]') || null,
        state: get('[data-f="state"]') || null,
        types: chips.length ? chips : old.types,        // behåll om tomt
        type: (chips[0] || old.type || null),           // primär typ = första
        photo_url: (get('[data-f="photo_url"]') || null),
        updated_at: new Date().toISOString()
      };
      return payload;
    }
  </script>
</body>
</html>
