<!-- Backoffice V4 — Moderation + Continent + Access | 2025-10-22 -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Backoffice — Moderation (V4)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --bg:#f5f6f8; --card:#ffffff; --text:#111; --muted:#667085; --border:#e5e7eb;
    --primary:#2f78c4; --primary-dark:#245f9a;
    --gold:#d4af37; --gold-dark:#b8911b;
    --green:#28a745; --blue:#007bff; --red:#d9534f; --amber:#ffb020;
    --shadow:0 8px 24px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}

  .wrap{max-width:1200px;margin:0 auto;padding:1.2rem}

  /* Topbar */
  .topbar{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin-bottom:.8rem}
  .btn{
    background:#fff;border:1.6px solid var(--primary);color:var(--primary);
    padding:.5rem .8rem;border-radius:10px;font-weight:800;cursor:pointer;
  }
  .btn:hover{background:var(--primary);color:#fff}
  .btn.primary{background:var(--primary);color:#fff;border:none}
  .btn.danger{border-color:var(--red);color:var(--red)}
  .btn.danger:hover{background:var(--red);color:#fff}

  /* Filters row */
  .filters{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:center;margin:.6rem 0 1rem}
  .pill{padding:.4rem .7rem;border:1.6px solid var(--primary);border-radius:999px;font-weight:800;cursor:pointer;background:#fff;color:var(--primary)}
  .pill.active{background:var(--primary);color:#fff}
  .searchbar{display:flex;gap:.4rem;flex-wrap:wrap;justify-content:center;margin:.4rem 0}
  .searchbar input{
    padding:.55rem .7rem;border:1.6px solid var(--primary);border-radius:10px;font-size:.95rem;min-width:260px;background:#fff;color:#111
  }
  .viewtoggle{display:flex;gap:.4rem;align-items:center;margin-top:.2rem}
  .viewtoggle .seg{padding:.35rem .6rem;border:1.6px solid var(--border);border-radius:9px;cursor:pointer;font-weight:800;color:#333;background:#fff}
  .viewtoggle .seg.active{border-color:var(--primary);color:#fff;background:var(--primary)}

  /* Grid cards */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}
  .card{
    background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;
    display:flex;flex-direction:column;
    transition:transform .18s ease, box-shadow .18s ease;
  }
  .card:hover{transform:translateY(-2px);box-shadow:0 12px 26px rgba(0,0,0,.12)}
  .card-img{width:100%;height:170px;object-fit:cover;background:#000}
  .card-body{padding:1rem;display:flex;flex-direction:column;gap:.55rem}
  .title{font-weight:900;font-size:1.05rem}
  .row{display:flex;flex-wrap:wrap;gap:.35rem;align-items:center}
  .muted{color:var(--muted);font-size:.9rem}
  .badges{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.15rem}
  .badge{font-size:.78rem;font-weight:800;border-radius:6px;padding:.25rem .45rem}
  .b-store{background:var(--blue);color:#fff}
  .b-lounge{background:var(--green);color:#fff}
  .b-public{background:var(--green);color:#fff}
  .b-membership{background:var(--gold);color:#111}
  .b-membersonly{background:var(--red);color:#fff}
  .b-continent{background:#111;color:#f3f3f3;border:1px solid #333}
  .rating{color:var(--gold);letter-spacing:.5px;font-weight:800}

  .meta{display:flex;justify-content:space-between;gap:.6rem;margin-top:.4rem;color:#666;font-size:.85rem}
  .actions{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.6rem}
  .btn.sm{padding:.35rem .55rem;border-radius:8px;font-size:.85rem}

  /* Edit form inside card */
  .edit-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-top:.4rem}
  .edit-grid .full{grid-column:1/-1}
  .edit-grid input,.edit-grid select{width:100%;padding:.45rem .55rem;border:1px solid #cfd4dc;border-radius:8px}

  /* Approved list view (text format) */
  .table-wrap{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);overflow:auto}
  table{width:100%;border-collapse:collapse;min-width:900px}
  th,td{padding:.65rem .7rem;border-bottom:1px solid #f0f2f5;text-align:left;font-size:.92rem}
  th{background:#f8fafc;color:#333;font-weight:900}
  tr:hover td{background:#fafcff}
  .t-actions{white-space:nowrap}

  /* Toasts */
  #toast-container{position:fixed;bottom:1rem;right:1rem;display:flex;flex-direction:column;gap:.5rem;z-index:9999}
  .toast{background:#333;color:#fff;padding:.7rem 1rem;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.28);opacity:.97}
  .toast.success{background:#28a745}.toast.error{background:#dc3545}.toast.info{background:#2f78c4}
</style>
</head>
<body>
  <div class="wrap">

    <!-- Topbar -->
    <div class="topbar">
      <button class="btn" onclick="location.href='add-store-backoffice.html'">＋ Add Store</button>
      <button class="btn" onclick="location.href='analytics.html'">📊 Analytics</button>
      <button class="btn" onclick="reloadData()">⟲ Reload</button>
    </div>

    <!-- Filters -->
    <div class="filters">
      <button class="pill" data-tab="all">All</button>
      <button class="pill" data-tab="approved">Approved</button>
      <button class="pill active" data-tab="pending">Pending</button>
      <button class="pill" data-tab="flagged">Flagged</button>
      <button class="pill" data-tab="deleted">Trash</button>
    </div>

    <div class="searchbar">
      <input id="searchInput" placeholder="Search by name, city, country…" />
      <div class="viewtoggle">
        <span class="seg" data-view="list">List</span>
        <span class="seg active" data-view="cards">Cards</span>
      </div>
    </div>

    <!-- Dynamic content -->
    <div id="cards" class="grid" style="display:none"></div>

    <div id="table" class="table-wrap" style="display:none">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Country</th>
            <th>Continent</th>
            <th>City</th>
            <th>Type</th>
            <th>Access</th>
            <th>Rating</th>
            <th>Added</th>
            <th>Added by</th>
            <th>Status</th>
            <th class="t-actions">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

  </div>

  <div id="toast-container"></div>

<script>
/* ====== Config ====== */
const SUPABASE_URL = "https://gbxxoeplkzbhsvagnfsr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== State ====== */
let ALL = [];
let currentTab = "pending";          // pending default
let currentView = "cards";           // cards default
let editingId = null;

/* ====== Utils ====== */
const $ = (s, p=document)=>p.querySelector(s);
function toast(msg,type="info"){
  const c=$("#toast-container"); const t=document.createElement("div");
  t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t);
  setTimeout(()=>t.remove(),3200);
}
function esc(s){return String(s ?? "").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
function fmtDate(s){
  if(!s) return "–";
  const d=new Date(s);
  if(Number.isNaN(d.getTime())) return esc(s);
  return d.toISOString().slice(0,16).replace("T"," ");
}
function stars(n){
  const v = Math.round(Number(n)||0);
  return "★★★★★".slice(0,v) + "☆☆☆☆☆".slice(0,5-v);
}

/* Google-compatible country -> continent (fallback if DB empty) */
function countryToContinent(country){
  if(!country) return "Other";
  const c = country.trim().toLowerCase();
  const m = {
    "afghanistan":"Asia","albania":"Europe","algeria":"Africa","andorra":"Europe","angola":"Africa",
    "antigua and barbuda":"North America","argentina":"South America","armenia":"Asia","australia":"Oceania","austria":"Europe",
    "azerbaijan":"Asia","bahamas":"North America","bahrain":"Asia","bangladesh":"Asia","barbados":"North America",
    "belarus":"Europe","belgium":"Europe","belize":"North America","benin":"Africa","bhutan":"Asia",
    "bolivia":"South America","bosnia and herzegovina":"Europe","botswana":"Africa","brazil":"South America","brunei":"Asia",
    "bulgaria":"Europe","burkina faso":"Africa","burundi":"Africa","cabo verde":"Africa","cambodia":"Asia",
    "cameroon":"Africa","canada":"North America","central african republic":"Africa","chad":"Africa","chile":"South America",
    "china":"Asia","colombia":"South America","comoros":"Africa","congo":"Africa","democratic republic of the congo":"Africa",
    "costa rica":"North America","croatia":"Europe","cuba":"North America","cyprus":"Asia","czech republic":"Europe","czechia":"Europe",
    "denmark":"Europe","djibouti":"Africa","dominica":"North America","dominican republic":"North America","ecuador":"South America",
    "egypt":"Africa","el salvador":"North America","equatorial guinea":"Africa","eritrea":"Africa","estonia":"Europe",
    "eswatini":"Africa","ethiopia":"Africa","fiji":"Oceania","finland":"Europe","france":"Europe",
    "gabon":"Africa","gambia":"Africa","georgia":"Asia","germany":"Europe","ghana":"Africa",
    "greece":"Europe","grenada":"North America","guatemala":"North America","guinea":"Africa","guinea-bissau":"Africa",
    "guyana":"South America","haiti":"North America","honduras":"North America","hungary":"Europe","iceland":"Europe",
    "india":"Asia","indonesia":"Asia","iran":"Asia","iraq":"Asia","ireland":"Europe",
    "israel":"Asia","italy":"Europe","ivory coast":"Africa","jamaica":"North America","japan":"Asia",
    "jordan":"Asia","kazakhstan":"Asia","kenya":"Africa","kiribati":"Oceania","kosovo":"Europe",
    "kuwait":"Asia","kyrgyzstan":"Asia","laos":"Asia","latvia":"Europe","lebanon":"Asia",
    "lesotho":"Africa","liberia":"Africa","libya":"Africa","liechtenstein":"Europe","lithuania":"Europe",
    "luxembourg":"Europe","madagascar":"Africa","malawi":"Africa","malaysia":"Asia","maldives":"Asia",
    "mali":"Africa","malta":"Europe","marshall islands":"Oceania","mauritania":"Africa","mauritius":"Africa",
    "mexico":"North America","micronesia":"Oceania","moldova":"Europe","monaco":"Europe","mongolia":"Asia",
    "montenegro":"Europe","morocco":"Africa","mozambique":"Africa","myanmar":"Asia","namibia":"Africa",
    "nauru":"Oceania","nepal":"Asia","netherlands":"Europe","new zealand":"Oceania","nicaragua":"North America",
    "niger":"Africa","nigeria":"Africa","north korea":"Asia","north macedonia":"Europe","norway":"Europe",
    "oman":"Asia","pakistan":"Asia","palau":"Oceania","palestine":"Asia","panama":"North America",
    "papua new guinea":"Oceania","paraguay":"South America","peru":"South America","philippines":"Asia","poland":"Europe",
    "portugal":"Europe","qatar":"Asia","romania":"Europe","russia":"Europe","rwanda":"Africa",
    "saint kitts and nevis":"North America","saint lucia":"North America","saint vincent and the grenadines":"North America","samoa":"Oceania","san marino":"Europe",
    "sao tome and principe":"Africa","saudi arabia":"Asia","senegal":"Africa","serbia":"Europe","seychelles":"Africa",
    "sierra leone":"Africa","singapore":"Asia","slovakia":"Europe","slovenia":"Europe","solomon islands":"Oceania",
    "somalia":"Africa","south africa":"Africa","south korea":"Asia","south sudan":"Africa","spain":"Europe",
    "sri lanka":"Asia","sudan":"Africa","suriname":"South America","sweden":"Europe","switzerland":"Europe",
    "syria":"Asia","taiwan":"Asia","tajikistan":"Asia","tanzania":"Africa","thailand":"Asia",
    "timor-leste":"Asia","togo":"Africa","tonga":"Oceania","trinidad and tobago":"North America","tunisia":"Africa",
    "turkey":"Asia","turkmenistan":"Asia","tuvalu":"Oceania","uganda":"Africa","ukraine":"Europe",
    "united arab emirates":"Asia","united kingdom":"Europe","united states":"North America","uruguay":"South America","uzbekistan":"Asia",
    "vanuatu":"Oceania","vatican city":"Europe","venezuela":"South America","vietnam":"Asia","yemen":"Asia",
    "zambia":"Africa","zimbabwe":"Africa",
    "hong kong":"Asia","puerto rico":"North America","macau":"Asia","greenland":"North America"
  };
  return m[c] || "Other";
}

/* ====== Load ====== */
document.addEventListener("DOMContentLoaded", async()=>{
  bindUI();
  await reloadData();
});

async function reloadData(){
  const { data, error } = await supabase
    .from("stores")
    .select("*")
    .order("created_at", { ascending:false });
  if(error){ console.error(error); toast("Failed to load data","error"); return; }
  ALL = (data||[]).map(s=>({
    ...s,
    continent: s.continent || countryToContinent(s.country)
  }));
  render();
}

/* ====== Filters / View ====== */
function bindUI(){
  document.querySelectorAll(".pill").forEach(p=>{
    p.addEventListener("click",()=>{
      document.querySelectorAll(".pill").forEach(x=>x.classList.remove("active"));
      p.classList.add("active");
      currentTab = p.dataset.tab;
      // Default view behavior per tab
      if(currentTab==="approved"){ setView("list"); } else { setView("cards"); }
      render();
    });
  });

  document.querySelectorAll(".viewtoggle .seg").forEach(seg=>{
    seg.addEventListener("click",()=>{
      document.querySelectorAll(".viewtoggle .seg").forEach(x=>x.classList.remove("active"));
      seg.classList.add("active");
      currentView = seg.dataset.view;
      render();
    });
  });

  $("#searchInput").addEventListener("input",render);
}

function setView(v){
  currentView = v;
  document.querySelectorAll(".viewtoggle .seg").forEach(x=>x.classList.toggle("active", x.dataset.view===v));
}

function filtered(){
  let arr = [...ALL];
  if(currentTab==="approved") arr = arr.filter(s=>s.approved && !s.deleted);
  if(currentTab==="pending")  arr = arr.filter(s=>!s.approved && !s.deleted);
  if(currentTab==="flagged")  arr = arr.filter(s=>s.flagged && !s.deleted);
  if(currentTab==="deleted")  arr = arr.filter(s=>s.deleted);
  const q = $("#searchInput").value.trim().toLowerCase();
  if(q){
    arr = arr.filter(s =>
      (s.name||"").toLowerCase().includes(q) ||
      (s.city||"").toLowerCase().includes(q) ||
      (s.country||"").toLowerCase().includes(q) ||
      (s.address||"").toLowerCase().includes(q)
    );
  }
  return arr;
}

/* ====== Render ====== */
function render(){
  const list = filtered();
  const showCards = (currentView==="cards");

  // default: Approved -> list; others -> cards (but user can toggle)
  $("#cards").style.display = showCards ? "" : "none";
  $("#table").style.display = !showCards ? "" : "none";

  if(showCards){ renderCards(list); }
  else { renderTable(list); }
}

function cardBadges(s){
  const arr=[];
  const tt = (s.types && Array.isArray(s.types) ? s.types : (s.type? [s.type] : []))
    .map(x=>String(x||"").toLowerCase());
  if(tt.includes("store"))  arr.push(`<span class="badge b-store">Store</span>`);
  if(tt.includes("lounge")) arr.push(`<span class="badge b-lounge">Lounge</span>`);
  if(s.access){
    const a = String(s.access).toLowerCase();
    if(a==="public") arr.push(`<span class="badge b-public">Public</span>`);
    else if(a==="membership") arr.push(`<span class="badge b-membership">Membership</span>`);
    else if(a==="members") arr.push(`<span class="badge b-membersonly">Members Only</span>`);
  }
  if(s.continent){
    arr.push(`<span class="badge b-continent">🌍 ${esc(s.continent)}</span>`);
  }
  return arr.join(" ");
}

function cardImageSrc(s){
  if(s.photo_url) return s.photo_url;
  if(s.photo_reference){
    // Fallback Google photo endpoint; your key is already loaded in project
    return `https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photo_reference=${encodeURIComponent(s.photo_reference)}&key=AIzaSyDdn7E6_dfwUjGQ1IUdJ2rQXUeEYIIzVtQ`;
  }
  // Default per type
  const tt = (s.types && s.types.length ? s.types : (s.type? [s.type] : [])).map(x=>String(x||"").toLowerCase());
  return tt.includes("lounge") ? "images/lounge.jpg" : "images/store.jpg";
}

function renderCards(list){
  const c = $("#cards");
  c.innerHTML = list.map(s=>{
    const ratingStars = stars(s.rating);
    const img = cardImageSrc(s);
    const status = s.deleted ? "Deleted" : s.flagged ? "Flagged" : s.approved ? "Approved" : "Pending";
    const actions = cardActionsFor(s);

    return `
    <div class="card" data-id="${s.id}">
      <img class="card-img" src="${esc(img)}" alt="${esc(s.name||'')}" onerror="this.src='images/store.jpg'">
      <div class="card-body">
        <div class="title">${esc(s.name||"–")}</div>
        <div class="badges">${cardBadges(s)}</div>
        <div class="row rating" title="Rating">${ratingStars}</div>
        <div class="row muted">📍 ${esc(s.city||"")}${s.city&&s.country?', ':''}${esc(s.country||"")}</div>
        <div class="row muted">🏠 ${esc(s.address||"–")}</div>
        ${s.phone?`<div class="row muted">📞 ${esc(s.phone)}</div>`:""}
        ${s.website?`<div class="row"><a href="${esc(s.website)}" target="_blank" rel="noopener">🌐 ${esc(s.website)}</a></div>`:""}
        <div class="meta">
          <div>🕓 ${fmtDate(s.created_at)}</div>
          <div>${s.added_by?`👤 ${esc(s.added_by)}`:""}</div>
        </div>

        <!-- Inline edit form (hidden by default; toggled per card) -->
        <div class="edit-zone" style="display:none">
          <div class="edit-grid">
            <input class="full" data-k="name" value="${esc(s.name||"")}" placeholder="Name">
            <input data-k="phone" value="${esc(s.phone||"")}" placeholder="Phone">
            <input data-k="website" value="${esc(s.website||"")}" placeholder="https://">
            <input class="full" data-k="address" value="${esc(s.address||"")}" placeholder="Address">
            <input data-k="city" value="${esc(s.city||"")}" placeholder="City">
            <input data-k="state" value="${esc(s.state||"")}" placeholder="State/Region">
            <input data-k="country" value="${esc(s.country||"")}" placeholder="Country">
            <select data-k="access">
              <option value="">Access…</option>
              <option value="public" ${s.access==='public'?'selected':''}>Public</option>
              <option value="membership" ${s.access==='membership'?'selected':''}>Membership</option>
              <option value="members" ${s.access==='members'?'selected':''}>Members Only</option>
            </select>
            <select data-k="type">
              <option value="">Type…</option>
              <option value="store" ${s.type==='store'?'selected':''}>Store</option>
              <option value="lounge" ${s.type==='lounge'?'selected':''}>Lounge</option>
              <option value="other" ${s.type==='other'?'selected':''}>Other</option>
            </select>
            <input type="number" min="0" max="5" step="1" data-k="rating" value="${Number(s.rating||0)}" placeholder="Rating 0–5">
            <input class="full" data-k="photo_url" value="${esc(s.photo_url||"")}" placeholder="Photo URL">
          </div>
        </div>

        <div class="row muted">Status: <strong>${status}</strong></div>
        <div class="actions">${actions}</div>
      </div>
    </div>`;
  }).join("");

  // bind actions
  c.querySelectorAll("[data-act]").forEach(b=>{
    b.addEventListener("click", onCardAction);
  });
}

function cardActionsFor(s){
  const id = s.id;
  const arr=[];
  // moderation set
  if(!s.deleted){
    if(!s.approved) arr.push(`<button class="btn sm" data-act="approve" data-id="${id}">Approve</button>`);
    else            arr.push(`<button class="btn sm" data-act="unapprove" data-id="${id}">Unapprove</button>`);

    if(!s.flagged)  arr.push(`<button class="btn sm" data-act="flag" data-id="${id}">Flag</button>`);
    else            arr.push(`<button class="btn sm" data-act="unflag" data-id="${id}">Unflag</button>`);

    arr.push(`<button class="btn sm" data-act="edit" data-id="${id}">Edit</button>`);
    arr.push(`<button class="btn sm danger" data-act="delete" data-id="${id}">Delete</button>`);
    arr.push(`<button class="btn sm" data-act="save" data-id="${id}" style="display:none">Save</button>`);
    arr.push(`<button class="btn sm" data-act="cancel" data-id="${id}" style="display:none">Cancel</button>`);
  } else {
    arr.push(`<button class="btn sm" data-act="restore" data-id="${id}">Restore</button>`);
  }
  return arr.join(" ");
}

function onCardAction(e){
  const act = e.currentTarget.dataset.act;
  const id  = e.currentTarget.dataset.id;
  const card = e.currentTarget.closest(".card");
  if(!id || !card) return;

  if(act==="approve") return setApproved(id,true);
  if(act==="unapprove") return setApproved(id,false);
  if(act==="flag") return setFlagged(id,true);
  if(act==="unflag") return setFlagged(id,false);
  if(act==="delete") return setDeleted(id,true);
  if(act==="restore") return setDeleted(id,false);

  const ez = card.querySelector(".edit-zone");
  const btnEdit   = card.querySelector(`[data-act="edit"]`);
  const btnSave   = card.querySelector(`[data-act="save"]`);
  const btnCancel = card.querySelector(`[data-act="cancel"]`);

  if(act==="edit"){
    editingId = id;
    ez.style.display="";
    btnSave.style.display="";
    btnCancel.style.display="";
    btnEdit.style.display="none";
    return;
  }
  if(act==="cancel"){
    editingId = null;
    ez.style.display="none";
    btnSave.style.display="none";
    btnCancel.style.display="none";
    if(btnEdit) btnEdit.style.display="";
    return;
  }
  if(act==="save"){
    const payload = {};
    ez.querySelectorAll("[data-k]").forEach(inp=>{
      const k = inp.dataset.k;
      let v = inp.value.trim();
      if(k==="rating") v = Number(v||0);
      payload[k]= v||null;
    });
    // maintain types from 'type'
    if(payload.type){
      payload.types = [payload.type];
    }
    // ensure continent if country changed
    if(payload.country && !payload.continent){
      payload.continent = countryToContinent(payload.country);
    }
    return saveEdit(id, payload, card);
  }
}

async function setApproved(id, val){
  const { error } = await supabase.from("stores").update({ approved:val }).eq("id", id);
  if(error){ console.error(error); toast("Update failed","error"); return;}
  toast(val?"Approved ✅":"Unapproved","success");
  await reloadData();
}
async function setFlagged(id, val){
  const { error } = await supabase.from("stores").update({ flagged:val }).eq("id", id);
  if(error){ console.error(error); toast("Update failed","error"); return;}
  toast(val?"Flagged 🚩":"Unflagged","success");
  await reloadData();
}
async function setDeleted(id, val){
  const { error } = await supabase.from("stores").update({ deleted:val }).eq("id", id);
  if(error){ console.error(error); toast("Update failed","error"); return;}
  toast(val?"Moved to Trash 🗑️":"Restored","success");
  await reloadData();
}
async function saveEdit(id, payload, card){
  const { error } = await supabase.from("stores").update(payload).eq("id", id);
  if(error){ console.error(error); toast("Save failed","error"); return;}
  toast("Saved ✔","success");
  editingId = null;
  await reloadData();
}

/* ====== Table (Approved default) ====== */
function renderTable(list){
  const tb = $("#tbody");
  tb.innerHTML = list.map(s=>{
    const status = s.deleted ? "Deleted" : s.flagged ? "Flagged" : s.approved ? "Approved" : "Pending";
    const acts = tableActionsFor(s);
    const types = (s.types && s.types.length ? s.types : (s.type? [s.type] : [])).join(", ");
    const access = s.access ? (s.access==="members"?"Members Only":s.access[0].toUpperCase()+s.access.slice(1)) : "–";
    return `<tr data-id="${s.id}">
      <td>${esc(s.name||"–")}</td>
      <td>${esc(s.country||"–")}</td>
      <td>${esc(s.continent||"–")}</td>
      <td>${esc(s.city||"–")}</td>
      <td>${esc(types||"–")}</td>
      <td>${esc(access)}</td>
      <td>${Number(s.rating||0)}</td>
      <td>${fmtDate(s.created_at)}</td>
      <td>${esc(s.added_by||"")}</td>
      <td>${status}</td>
      <td class="t-actions">${acts}</td>
    </tr>`;
  }).join("");

  tb.querySelectorAll("[data-act]").forEach(b=>{
    b.addEventListener("click", onTableAction);
  });
}

function tableActionsFor(s){
  const id = s.id;
  const arr=[];
  if(!s.deleted){
    if(!s.approved) arr.push(`<button class="btn sm" data-act="approve" data-id="${id}">Approve</button>`);
    else            arr.push(`<button class="btn sm" data-act="unapprove" data-id="${id}">Unapprove</button>`);
    if(!s.flagged)  arr.push(`<button class="btn sm" data-act="flag" data-id="${id}">Flag</button>`);
    else            arr.push(`<button class="btn sm" data-act="unflag" data-id="${id}">Unflag</button>`);
    arr.push(`<button class="btn sm danger" data-act="delete" data-id="${id}">Delete</button>`);
  } else {
    arr.push(`<button class="btn sm" data-act="restore" data-id="${id}">Restore</button>`);
  }
  // Quick-edit opens a lightweight prompt set
  arr.push(`<button class="btn sm" data-act="qedit" data-id="${id}">Edit</button>`);
  return arr.join(" ");
}

function onTableAction(e){
  const act = e.currentTarget.dataset.act;
  const id  = e.currentTarget.dataset.id;
  if(act==="approve") return setApproved(id,true);
  if(act==="unapprove") return setApproved(id,false);
  if(act==="flag") return setFlagged(id,true);
  if(act==="unflag") return setFlagged(id,false);
  if(act==="delete") return setDeleted(id,true);
  if(act==="restore") return setDeleted(id,false);
  if(act==="qedit") return quickEditRow(id);
}

async function quickEditRow(id){
  const item = ALL.find(x=>x.id===id);
  if(!item) return;
  const name = prompt("Name:", item.name||"");
  if(name===null) return;
  const phone = prompt("Phone:", item.phone||"");
  if(phone===null) return;
  const website = prompt("Website:", item.website||"");
  if(website===null) return;

  const payload = { name, phone, website };
  const { error } = await supabase.from("stores").update(payload).eq("id", id);
  if(error){ console.error(error); toast("Save failed","error"); return;}
  toast("Saved ✔","success");
  await reloadData();
}
</script>
</body>
</html>
