<!-- Backoffice — Business Analytics V3 (Continent Integration) | 2025-10-22 -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Backoffice — Business Analytics (V3)</title>

  <!-- ✅ Non-module Supabase + Chart.js + XLSX (works on GitHub Pages) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --primary:#2f78c4; --primary-dark:#2466a8;
      --accent:#28a745; --bg:#f5f6f8; --card:#fff;
      --text:#1f2937; --muted:#6b7280; --border:#e5e7eb;
    }
    *{box-sizing:border-box;}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:1.2rem;color:var(--text);font-size:10px;}

    h1{text-align:center;margin:0 0 1rem;color:#2b2b2b;font-weight:800;font-size:1.4rem;}

    nav{display:flex;justify-content:center;align-items:center;gap:.4rem;flex-wrap:wrap;margin-bottom:1rem;}
    nav a,nav button{
      background:#fff;border:1.4px solid var(--primary);color:var(--primary);
      padding:.35rem .6rem;border-radius:7px;font-weight:800;text-decoration:none;font-size:.9rem;cursor:pointer;
    }
    nav a:hover,nav button:hover{background:var(--primary);color:#fff;}

    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.5rem;margin-bottom:.8rem;}
    .stat-card{
      background:var(--card);border:1px solid var(--border);border-radius:9px;
      box-shadow:0 1px 3px rgba(0,0,0,.05);padding:.6rem;text-align:center;cursor:pointer;
      transition:transform .1s, box-shadow .1s;
    }
    .stat-card:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,.1);}
    .stat-card.active{background:var(--accent);color:#fff;}
    .stat-card h2{margin:.05rem 0;font-size:1.3rem;font-weight:800;}
    .stat-card p{margin:0;font-size:.9rem;opacity:.9;}

    .panel{background:var(--card);border:1px solid var(--border);border-radius:9px;box-shadow:0 1px 3px rgba(0,0,0,.05);padding:.6rem;margin-bottom:.8rem;}
    .row{display:flex;flex-wrap:wrap;gap:.4rem;justify-content:center;align-items:center;}
    .btn{
      background:#fff;border:1.4px solid var(--primary);color:var(--primary);
      padding:.35rem .6rem;border-radius:7px;font-weight:800;font-size:.9rem;cursor:pointer;
    }
    .btn:hover{background:var(--primary);color:#fff;}
    .btn.active{background:var(--primary);color:#fff;}
    #toggleCharts{background:var(--primary);color:#fff;border:none;}
    #toggleCharts:hover{background:var(--primary-dark);}
    .select{
      border:1.4px solid var(--primary);border-radius:7px;padding:.32rem .5rem;
      color:var(--primary);background:#fff;font-weight:800;font-size:.9rem;
    }
    .chart-title{text-align:center;font-weight:900;font-size:1rem;margin:.4rem 0;}
    .chart-wrap{padding:.5rem;}
    #chartsPanel.minimized{height:40px;overflow:hidden;}

    table{width:100%;border-collapse:collapse;table-layout:fixed;}
    th,td{padding:.5rem;border-bottom:1px solid #eee;text-align:left;font-size:.9rem;}
    th{background:#f3f4f6;color:#333;cursor:pointer;}
    tr:hover{background:#f9fafb;}
    td.num{text-align:center;}
    .status{font-weight:800;}
    .approved{color:#1d8348}.flagged{color:#c0392b}.pending{color:#b36e00}.deleted{color:#777}
  </style>
</head>
<body>
  <h1>World Cigar Locator — Business Analytics</h1>

  <nav>
    <a href="backoffice.html"><strong>Home</strong></a>
    <a href="add-store-backoffice.html">Add Store</a>
    <a href="analytics.html">Analytics</a>
    <a href="#top" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">↑ Top</a>
  </nav>

  <!-- KPI -->
  <div class="stats-grid" id="kpiGrid">
    <div class="stat-card" data-kpi="all"><h2 id="kpiTotal">–</h2><p>Total Locations</p></div>
    <div class="stat-card" data-kpi="approved"><h2 id="kpiApproved">–</h2><p>Approved</p></div>
    <div class="stat-card" data-kpi="pending"><h2 id="kpiPending">–</h2><p>Pending</p></div>
    <div class="stat-card" data-kpi="flagged"><h2 id="kpiFlagged">–</h2><p>Flagged</p></div>
    <div class="stat-card" data-kpi="deleted"><h2 id="kpiDeleted">–</h2><p>Deleted</p></div>
    <div class="stat-card" data-kpi="views"><h2 id="kpiViews">Top</h2><p>Most Views</p></div>
    <div class="stat-card" data-kpi="clicks"><h2 id="kpiClicks">Top</p><p>Most Clicks</p></div>
    <div class="stat-card" data-kpi="ctr"><h2 id="kpiCtr">Top</h2><p>Top CTR</p></div>
    <div class="stat-card" data-kpi="newmonth"><h2 id="kpiNewMonth">–</h2><p>New This Month</p></div>
  </div>

  <!-- Charts -->
  <div class="panel" id="chartsPanel">
    <div class="row">
      <button class="btn" id="toggleCharts">Hide Charts ▴</button>
      <select class="select" id="periodSelect">
        <option value="7">Last 7 Days</option>
        <option value="30" selected>Last 30 Days</option>
        <option value="365">Last 12 Months</option>
      </select>
      <button class="btn active" id="btnCountry">By Country</button>
      <button class="btn" id="btnContinent">By Continent</button>
      <button class="btn" id="btnType">By Type</button>
    </div>
    <div class="chart-title" id="chartTitle">Performance per Country</div>
    <div class="chart-wrap"><canvas id="chartCanvas" height="70"></canvas></div>
  </div>

  <!-- Table -->
  <div class="panel">
    <input id="searchInput" placeholder="Search..." style="padding:.4rem;border:1px solid var(--primary);border-radius:7px;font-size:.9rem;width:200px;margin-bottom:.6rem;">
    <table id="storesTable">
      <thead>
        <tr>
          <th data-sort="name">Name</th>
          <th data-sort="country">Country</th>
          <th data-sort="continent">Continent</th>
          <th data-sort="type">Type</th>
          <th data-sort="views">Views</th>
          <th data-sort="clicks">Clicks</th>
          <th data-sort="ctr">CTR (%)</th>
          <th data-sort="rating">Rating</th>
          <th data-sort="status">Status</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    /* ---------- INIT ---------- */
    const supabase = window.supabase.createClient(
      "https://gbxxoeplkzbhsvagnfsr.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4"
    );

    let allStores=[], currentFilter="all", currentChart="country", chartInstance=null, chartsVisible=true;
    const ctx = document.getElementById("chartCanvas").getContext("2d");
    const kpiEls = {
      total:kpiTotal, approved:kpiApproved, pending:kpiPending,
      flagged:kpiFlagged, deleted:kpiDeleted, newMonth:kpiNewMonth
    };

    /* ---------- Country→Continent (196) ---------- */
    function continentFromCountry(country){
      if(!country) return "Other";
      const c=country.trim().toLowerCase();
      const m={"afghanistan":"Asia","albania":"Europe","algeria":"Africa","andorra":"Europe","angola":"Africa","antigua and barbuda":"North America","argentina":"South America","armenia":"Asia","australia":"Oceania","austria":"Europe","azerbaijan":"Asia","bahamas":"North America","bahrain":"Asia","bangladesh":"Asia","barbados":"North America","belarus":"Europe","belgium":"Europe","belize":"North America","benin":"Africa","bhutan":"Asia","bolivia":"South America","bosnia and herzegovina":"Europe","botswana":"Africa","brazil":"South America","brunei":"Asia","bulgaria":"Europe","burkina faso":"Africa","burundi":"Africa","cabo verde":"Africa","cambodia":"Asia","cameroon":"Africa","canada":"North America","central african republic":"Africa","chad":"Africa","chile":"South America","china":"Asia","colombia":"South America","comoros":"Africa","congo":"Africa","democratic republic of the congo":"Africa","costa rica":"North America","croatia":"Europe","cuba":"North America","cyprus":"Asia","czech republic":"Europe","czechia":"Europe","denmark":"Europe","djibouti":"Africa","dominica":"North America","dominican republic":"North America","ecuador":"South America","egypt":"Africa","el salvador":"North America","equatorial guinea":"Africa","eritrea":"Africa","estonia":"Europe","eswatini":"Africa","ethiopia":"Africa","fiji":"Oceania","finland":"Europe","france":"Europe","gabon":"Africa","gambia":"Africa","georgia":"Asia","germany":"Europe","ghana":"Africa","greece":"Europe","grenada":"North America","guatemala":"North America","guinea":"Africa","guinea-bissau":"Africa","guyana":"South America","haiti":"North America","honduras":"North America","hungary":"Europe","iceland":"Europe","india":"Asia","indonesia":"Asia","iran":"Asia","iraq":"Asia","ireland":"Europe","israel":"Asia","italy":"Europe","ivory coast":"Africa","jamaica":"North America","japan":"Asia","jordan":"Asia","kazakhstan":"Asia","kenya":"Africa","kiribati":"Oceania","kosovo":"Europe","kuwait":"Asia","kyrgyzstan":"Asia","laos":"Asia","latvia":"Europe","lebanon":"Asia","lesotho":"Africa","liberia":"Africa","libya":"Africa","liechtenstein":"Europe","lithuania":"Europe","luxembourg":"Europe","madagascar":"Africa","malawi":"Africa","malaysia":"Asia","maldives":"Asia","mali":"Africa","malta":"Europe","marshall islands":"Oceania","mauritania":"Africa","mauritius":"Africa","mexico":"North America","micronesia":"Oceania","moldova":"Europe","monaco":"Europe","mongolia":"Asia","montenegro":"Europe","morocco":"Africa","mozambique":"Africa","myanmar":"Asia","namibia":"Africa","nauru":"Oceania","nepal":"Asia","netherlands":"Europe","new zealand":"Oceania","nicaragua":"North America","niger":"Africa","nigeria":"Africa","north korea":"Asia","north macedonia":"Europe","norway":"Europe","oman":"Asia","pakistan":"Asia","palau":"Oceania","palestine":"Asia","panama":"North America","papua new guinea":"Oceania","paraguay":"South America","peru":"South America","philippines":"Asia","poland":"Europe","portugal":"Europe","qatar":"Asia","romania":"Europe","russia":"Europe","rwanda":"Africa","saint kitts and nevis":"North America","saint lucia":"North America","saint vincent and the grenadines":"North America","samoa":"Oceania","san marino":"Europe","sao tome and principe":"Africa","saudi arabia":"Asia","senegal":"Africa","serbia":"Europe","seychelles":"Africa","sierra leone":"Africa","singapore":"Asia","slovakia":"Europe","slovenia":"Europe","solomon islands":"Oceania","somalia":"Africa","south africa":"Africa","south korea":"Asia","south sudan":"Africa","spain":"Europe","sri lanka":"Asia","sudan":"Africa","suriname":"South America","sweden":"Europe","switzerland":"Europe","syria":"Asia","taiwan":"Asia","tajikistan":"Asia","tanzania":"Africa","thailand":"Asia","timor-leste":"Asia","togo":"Africa","tonga":"Oceania","trinidad and tobago":"North America","tunisia":"Africa","turkey":"Asia","turkmenistan":"Asia","tuvalu":"Oceania","uganda":"Africa","ukraine":"Europe","united arab emirates":"Asia","united kingdom":"Europe","united states":"North America","usa":"North America","uruguay":"South America","uzbekistan":"Asia","vanuatu":"Oceania","vatican city":"Europe","venezuela":"South America","vietnam":"Asia","yemen":"Asia","zambia":"Africa","zimbabwe":"Africa"};
      return m[c]||"Other";
    }

    /* ---------- Load Data ---------- */
    loadData();
    async function loadData(){
      const { data, error } = await supabase.from("stores").select("*");
      if(error){console.error(error);return;}
      allStores=(data||[]).map(s=>({
        ...s,
        views:+(s.views||0),
        link_clicks:+(s.link_clicks||0),
        rating:+(s.rating||0),
        continent: s.continent || continentFromCountry(s.country)
      }));

      // 🛠 Uppdatera saknad continent till DB (bara de som saknar)
      const toUpdate = allStores.filter(s=>!s.continent || s.continent==="Other").filter(s=>s.country);
      for(const s of toUpdate){
        const cont = continentFromCountry(s.country);
        if(cont && cont!=="Other"){
          try{
            await supabase.from("stores").update({continent:cont}).eq("id", s.id);
            s.continent = cont;
          }catch(e){ console.warn("Update continent failed for", s.id, e); }
        }
      }

      renderKPIs();
      renderTable();
      renderChart();
      updateTopKpis();
    }

    /* ---------- KPIs ---------- */
    function renderKPIs(){
      const total=allStores.length;
      const approved=allStores.filter(s=>s.approved).length;
      const pending=allStores.filter(s=>!s.approved && !s.deleted).length;
      const flagged=allStores.filter(s=>s.flagged).length;
      const deleted=allStores.filter(s=>s.deleted).length;
      const monthCut=new Date();monthCut.setDate(monthCut.getDate()-30);
      const newMonth=allStores.filter(s=>s.created_at && new Date(s.created_at)>=monthCut).length;

      kpiEls.total.textContent=total;
      kpiEls.approved.textContent=approved;
      kpiEls.pending.textContent=pending;
      kpiEls.flagged.textContent=flagged;
      kpiEls.deleted.textContent=deleted;
      kpiEls.newMonth.textContent=newMonth;
    }

    function updateTopKpis(){
      // Top views/clicks/ctr labels
      const topViews = [...allStores].sort((a,b)=>b.views-a.views)[0];
      const topClicks = [...allStores].sort((a,b)=>b.link_clicks-a.link_clicks)[0];
      const topCtr = [...allStores].filter(s=>s.views>0).sort((a,b)=> (b.link_clicks/b.views) - (a.link_clicks/a.views))[0];
      if(document.getElementById("kpiViews")) kpiViews.textContent = topViews?.name || "Top";
      if(document.getElementById("kpiClicks")) kpiClicks.textContent = topClicks?.name || "Top";
      if(document.getElementById("kpiCtr")) kpiCtr.textContent = topCtr?.name || "Top";
    }

    /* ---------- Filters + Search ---------- */
    function filtered(){
      let arr=[...allStores];
      if(currentFilter==="approved")arr=arr.filter(s=>s.approved);
      if(currentFilter==="pending")arr=arr.filter(s=>!s.approved && !s.deleted);
      if(currentFilter==="flagged")arr=arr.filter(s=>s.flagged);
      if(currentFilter==="deleted")arr=arr.filter(s=>s.deleted);
      const q=(document.getElementById("searchInput").value||"").toLowerCase();
      if(q)arr=arr.filter(s=>(s.name||"").toLowerCase().includes(q)||(s.city||"").toLowerCase().includes(q)||(s.country||"").toLowerCase().includes(q)||(s.continent||"").toLowerCase().includes(q));
      return arr;
    }

    /* ---------- Table ---------- */
    function renderTable(){
      const tb=document.getElementById("tableBody");
      const rows = filtered().slice(0,800).map(s=>{
        const ctr = s.views>0 ? ((s.link_clicks/s.views)*100).toFixed(1) : "0.0";
        const status = s.flagged?"flagged":s.approved?"approved":s.deleted?"deleted":"pending";
        const label  = s.flagged?"Flagged":s.approved?"Approved":s.deleted?"Deleted":"Pending";
        return `<tr>
          <td>${esc(s.name||"–")}</td>
          <td>${esc(s.country||"–")}</td>
          <td>${esc(s.continent||"–")}</td>
          <td>${esc(s.type||"–")}</td>
          <td class="num">${s.views}</td>
          <td class="num">${s.link_clicks}</td>
          <td class="num">${ctr}</td>
          <td class="num">${s.rating||0}</td>
          <td class="status ${status}">${label}</td>
        </tr>`;
      }).join("");
      tb.innerHTML = rows || `<tr><td colspan="9" style="text-align:center;color:#777;">No rows</td></tr>`;
    }

    /* ---------- Charts ---------- */
    function buildAgg(byKey){
      const m=new Map();
      filtered().forEach(s=>{
        const k=(s[byKey]||"Unknown").trim();
        if(!m.has(k)) m.set(k,{count:0});
        m.get(k).count++;
      });
      const arr=[...m.entries()].map(([k,v])=>({k, n:v.count})).sort((a,b)=>b.n-a.n).slice(0,15);
      return { labels: arr.map(x=>x.k), counts: arr.map(x=>x.n) };
    }

    function renderChart(){
      if(chartInstance){ chartInstance.destroy(); }
      const mode = currentChart;
      let agg;
      if(mode==="country")   agg = buildAgg("country");
      else if(mode==="continent") agg = buildAgg("continent");
      else /* type */        agg = buildAgg("type");

      chartInstance=new Chart(ctx,{
        type:'bar',
        data:{labels:agg.labels,datasets:[{label:'Locations',data:agg.counts,backgroundColor:"#2f78c4"}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
      chartTitle.textContent = `Performance per ${mode.charAt(0).toUpperCase()+mode.slice(1)}`;
    }

    /* ---------- Helpers ---------- */
    function esc(s){return String(s??"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

    /* ---------- Events ---------- */
    document.getElementById("searchInput").addEventListener("input",()=>{ renderTable(); renderChart(); });

    document.querySelectorAll(".stat-card").forEach(card=>{
      card.addEventListener("click",()=>{
        document.querySelectorAll(".stat-card").forEach(c=>c.classList.remove("active"));
        card.classList.add("active");
        currentFilter = card.dataset.kpi==="all" ? "all" : card.dataset.kpi;
        renderTable(); renderChart();
      });
    });

    const toggleBtn = document.getElementById("toggleCharts");
    toggleBtn?.addEventListener("click",()=>{
      chartsVisible=!chartsVisible;
      const p=document.getElementById("chartsPanel");
      if(chartsVisible){p.classList.remove("minimized");toggleBtn.textContent="Hide Charts ▴";renderChart();}
      else{p.classList.add("minimized");toggleBtn.textContent="Show Charts ▾";}
    });

    document.getElementById("btnCountry").addEventListener("click",()=>{ 
      document.querySelectorAll(".row .btn").forEach(b=>b.classList.remove("active"));
      btnCountry.classList.add("active");
      currentChart="country"; renderChart(); 
    });
    document.getElementById("btnContinent").addEventListener("click",()=>{ 
      document.querySelectorAll(".row .btn").forEach(b=>b.classList.remove("active"));
      btnContinent.classList.add("active");
      currentChart="continent"; renderChart(); 
    });
    document.getElementById("btnType").addEventListener("click",()=>{ 
      document.querySelectorAll(".row .btn").forEach(b=>b.classList.remove("active"));
      btnType.classList.add("active");
      currentChart="type"; renderChart(); 
    });

    // If you had a refresh/edge function button by id "runRefreshBtn" earlier:
    const runRefreshBtn = document.getElementById("runRefreshBtn");
    runRefreshBtn?.addEventListener("click",()=>{
      if(confirm("Are you sure you want to force refresh of all photo URLs?\n(This uses Google API quota.)")){
        alert("✅ Refresh placeholder — actual Edge Function not triggered in GH version.");
      }
    });
  </script>
</body>
</html>
