<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store</title>
  <link rel="stylesheet" href="css/start.css">
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    h1 {
      color: goldenrod;
    }
    .stars {
      font-size: 2rem;
      cursor: pointer;
      color: #ccc;
    }
    .stars span.active {
      color: gold;
    }
  </style>
</head>
<body>
  <h1 id="storeName">Loading...</h1>
  <p id="storeAddress"></p>
  <p><a id="storeLink" href="#" target="_blank">Visit external page</a></p>

  <h2>Rating</h2>
  <div id="starContainer" class="stars"></div>
  <p id="ratingInfo">Loading rating...</p>

  <!-- Supabase client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // üîë Byt ut mot din egen Supabase URL och anon key
    const supabaseUrl = "https://YOUR-PROJECT.supabase.co";
    const supabaseKey = "YOUR-ANON-KEY";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // H√§mta ?store=id fr√•n URL
    const params = new URLSearchParams(window.location.search);
    const storeId = params.get("store");

    if (!storeId) {
      document.getElementById("storeName").textContent = "No store selected.";
      throw new Error("No store ID in URL");
    }

    // Ladda butikens info
    async function loadStore() {
      const { data, error } = await supabaseClient
        .from("stores")
        .select("*")
        .eq("id", storeId)
        .single();

      if (error || !data) {
        document.getElementById("storeName").textContent = "Store not found.";
        return;
      }

      document.getElementById("storeName").textContent = data.name;
      document.getElementById("storeAddress").textContent = data.address || "";
      document.getElementById("storeLink").href = data.link || "#";
      document.getElementById("storeLink").textContent = data.link ? "Visit external page" : "";
    }

    // Rita stj√§rnor
    function renderStars(avg = 0) {
      const container = document.getElementById("starContainer");
      container.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const star = document.createElement("span");
        star.textContent = "‚òÖ";
        if (i <= avg) star.classList.add("active");
        star.addEventListener("click", () => saveRating(i));
        container.appendChild(star);
      }
    }

    // Ladda rating
    async function loadRating() {
      const { data, error } = await supabaseClient
        .from("ratings")
        .select("rating")
        .eq("store_id", storeId);

      if (error) {
        document.getElementById("ratingInfo").textContent = "‚ùå Error loading rating";
        return;
      }

      if (data.length === 0) {
        renderStars(0);
        document.getElementById("ratingInfo").textContent = "No ratings yet.";
        return;
      }

      const sum = data.reduce((acc, r) => acc + r.rating, 0);
      const avg = sum / data.length;
      renderStars(Math.round(avg));
      document.getElementById("ratingInfo").textContent = 
        `Average: ${avg.toFixed(1)} (${data.length} votes)`;
    }

    // Spara rating
    async function saveRating(value) {
      const { error } = await supabaseClient
        .from("ratings")
        .insert([{ store_id: storeId, rating: value }]);

      if (error) {
        alert("‚ùå Error saving rating: " + error.message);
      } else {
        loadRating();
      }
    }

    // K√∂r allt
    loadStore();
    loadRating();
  </script>
</body>
</html>
