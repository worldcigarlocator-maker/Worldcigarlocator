<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Store</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    .stars span { font-size: 2rem; cursor: pointer; color: #ccc; }
    .stars span.active { color: gold; }
    .review { margin: 1rem 0; padding: 0.5rem; border-bottom: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1 id="storeName"></h1>
  <p id="storeAddress"></p>
  <a id="storeLink" target="_blank"></a>

  <h2>Betyg</h2>
  <div id="ratingSummary"></div>
  <div class="stars" id="stars"></div>

  <h2>L√§mna recension</h2>
  <textarea id="reviewText" placeholder="Skriv en recension..."></textarea><br>
  <button id="submitReview">Skicka</button>

  <h2>Recensioner</h2>
  <div id="reviews"></div>

<script>
  // üîë Ditt Supabase-projekt
  const supabaseUrl = "DIN_SUPABASE_URL";
  const supabaseKey = "DIN_SUPABASE_ANON_KEY";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // H√§mta store_id fr√•n URL
  const urlParams = new URLSearchParams(window.location.search);
  const storeId = urlParams.get("store");

  const starsContainer = document.getElementById("stars");
  let selectedRating = 0;

  // Skapa 5 stj√§rnor
  for (let i = 1; i <= 5; i++) {
    const star = document.createElement("span");
    star.textContent = "‚òÖ";
    star.addEventListener("click", () => {
      selectedRating = i;
      highlightStars(i);
    });
    starsContainer.appendChild(star);
  }

  function highlightStars(count) {
    [...starsContainer.children].forEach((s, i) => {
      s.classList.toggle("active", i < count);
    });
  }

  // üöÄ H√§mta store-info
  async function loadStore() {
    const { data, error } = await supabaseClient
      .from("stores")
      .select("*")
      .eq("id", storeId)
      .single();

    if (data) {
      document.getElementById("storeName").textContent = data.name;
      document.getElementById("storeAddress").textContent = data.address;
      const link = document.getElementById("storeLink");
      link.textContent = data.link;
      link.href = data.link;
    }
  }

  // üöÄ H√§mta rating-sammanfattning fr√•n vyn
  async function loadRatingSummary() {
    const { data, error } = await supabaseClient
      .from("store_ratings_summary")
      .select("*")
      .eq("store_id", storeId)
      .single();

    if (data) {
      document.getElementById("ratingSummary").textContent =
        `Snittbetyg: ${data.average_rating || 0} (${data.total_ratings} r√∂ster, ${data.total_reviews} recensioner)`;
    } else {
      document.getElementById("ratingSummary").textContent =
        "Inga betyg √§n.";
    }
  }

  // üöÄ H√§mta recensioner
  async function loadReviews() {
    const { data, error } = await supabaseClient
      .from("ratings")
      .select("rating, review, created_at")
      .eq("store_id", storeId)
      .order("created_at", { ascending: false });

    const reviewsDiv = document.getElementById("reviews");
    reviewsDiv.innerHTML = "";
    if (data) {
      data.forEach(r => {
        const div = document.createElement("div");
        div.className = "review";
        div.textContent = `‚≠ê ${r.rating} ‚Äì ${r.review || ""}`;
        reviewsDiv.appendChild(div);
      });
    }
  }

  // üöÄ Spara ny recension
  document.getElementById("submitReview").addEventListener("click", async () => {
    const text = document.getElementById("reviewText").value;
    if (!selectedRating) {
      alert("V√§lj antal stj√§rnor f√∂rst!");
      return;
    }

    const { error } = await supabaseClient
      .from("ratings")
      .insert([{ store_id: storeId, rating: selectedRating, review: text }]);

    if (error) {
      alert("Kunde inte spara recensionen: " + error.message);
    } else {
      document.getElementById("reviewText").value = "";
      selectedRating = 0;
      highlightStars(0);
      await loadRatingSummary();
      await loadReviews();
    }
  });

  // Ladda allt
  loadStore();
  loadRatingSummary();
  loadReviews();
</script>
</body>
</html>
