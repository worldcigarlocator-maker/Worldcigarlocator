<script>
  const supabaseUrl = "https://gbxxoeplkzbhsvagnfsr.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieHhvZXBsa3piaHN2YWduZnNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc2NjQ1MDAsImV4cCI6MjA3MzI0MDUwMH0.E4Vk-GyLe22vyyfRy05hZtf4t5w_Bd_B-tkEFZ1alT4";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  let autocomplete;
  let selectedLat = null;
  let selectedLng = null;
  let selectedPlaceId = null;

  function initAutocomplete() {
    const input = document.getElementById("autocomplete");
    autocomplete = new google.maps.places.Autocomplete(input, { types: ["establishment"] });

    autocomplete.addListener("place_changed", () => {
      const place = autocomplete.getPlace();
      if (!place.address_components) return;

      selectedPlaceId = place.place_id || null;
      document.getElementById("name").value = place.name || "";
      document.getElementById("address").value = place.formatted_address || "";
      document.getElementById("phone").value = place.formatted_phone_number || "";
      document.getElementById("website").value = place.website || "";
      document.getElementById("city").value = getCity(place.address_components);
      document.getElementById("country").value = getCountry(place.address_components);

      if (place.geometry && place.geometry.location) {
        selectedLat = place.geometry.location.lat();
        selectedLng = place.geometry.location.lng();
      }

      const preview = document.getElementById("preview");
      if (place.photos && place.photos.length > 0) {
        const url = place.photos[0].getUrl({ maxWidth: 500 });
        preview.innerHTML = `<img src="${url}" alt="Preview">`;
      } else {
        preview.innerHTML = "";
      }
    });
  }

  function getCity(components) {
    let city = "";
    components.forEach(c => {
      if (c.types.includes("locality")) city = c.long_name;
      if (c.types.includes("postal_town")) city = c.long_name;
      if (c.types.includes("administrative_area_level_3") && !city) city = c.long_name;
      if (c.types.includes("administrative_area_level_2") && !city) city = c.long_name;
    });
    return city;
  }

  function getCountry(components) {
    const c = components.find(c => c.types.includes("country"));
    return c ? c.long_name : "";
  }

  function initStars() {
    const container = document.getElementById("stars");
    const hiddenInput = document.getElementById("rating");
    let selected = 0;

    for (let i = 1; i <= 5; i++) {
      const span = document.createElement("span");
      span.textContent = "â˜…";
      span.classList.add("star");
      span.dataset.value = i;

      span.addEventListener("click", () => {
        selected = i;
        hiddenInput.value = selected;
        document.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));
        for (let j = 0; j < selected; j++) document.querySelectorAll(".star")[j].classList.add("selected");
      });

      container.appendChild(span);
    }
  }

  document.getElementById("saveBtn").addEventListener("click", async () => {
    const btn = document.getElementById("saveBtn");
    btn.disabled = true;

    const name = document.getElementById("name").value.trim();
    const address = document.getElementById("address").value.trim();
    const city = document.getElementById("city").value.trim();
    const country = document.getElementById("country").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const website = document.getElementById("website").value.trim();
    const type = document.querySelector("input[name='type']:checked")?.value;
    const rating = parseInt(document.getElementById("rating").value || 0);

    if (!name || !address || !city || !country) {
      showToast("Please fill all required fields", "error");
      btn.disabled = false;
      return;
    }

    // ðŸš« Kontrollera dublett via place_id
    if (selectedPlaceId) {
      const { data: existing } = await supabase
        .from("stores")
        .select("place_id")
        .eq("place_id", selectedPlaceId);

      if (existing && existing.length > 0) {
        showToast("This place already exists!", "error");
        btn.disabled = false;
        return;
      }
    }

    const { error } = await supabase.from("stores").insert([{
      name, address, city, country, phone, website,
      type, rating,
      latitude: selectedLat, longitude: selectedLng,
      approved: false,
      place_id: selectedPlaceId
    }]);

    if (error) {
      console.error(error);
      showToast("Error saving store", "error");
    } else {
      showToast("Store added successfully!", "success");
      resetForm();
    }

    btn.disabled = false;
  });

  function resetForm() {
    document.getElementById("autocomplete").value = "";
    document.getElementById("name").value = "";
    document.getElementById("address").value = "";
    document.getElementById("city").value = "";
    document.getElementById("country").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("website").value = "";
    document.querySelectorAll("input[name='type']").forEach(r => r.checked = false);
    document.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));
    document.getElementById("rating").value = "";
    document.getElementById("preview").innerHTML = "";
  }

  function showToast(msg, type = "success") {
    const container = document.getElementById("toast-container");
    const div = document.createElement("div");
    div.className = `toast ${type}`;
    div.textContent = msg;
    container.appendChild(div);
    setTimeout(() => div.remove(), 3000);
  }

  window.addEventListener("load", () => {
    initAutocomplete();
    initStars();
  });
</script>
